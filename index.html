<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á –ë–∏—Ç—Ä–∏–∫—Å 24</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <meta name="color-scheme" content="light dark" />
  </head>
  <body class="min-h-dvh overflow-y-scroll bg-gray-50 text-gray-900 antialiased dark:bg-gray-900 dark:text-gray-100">
    <header class="border-b border-gray-200 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:border-gray-800 dark:bg-gray-900/60">
      <div class="mx-auto max-w-4xl px-4 py-4">
        <div class="flex items-center gap-3">
          <div>
            <h1 class="text-2xl font-semibold tracking-tight">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á –ë–∏—Ç—Ä–∏–∫—Å 24</h1>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –æ—Ç—á—ë—Ç–æ–º ‚Äî –ø–æ–∫–∞–∂–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
          </div>
          <div class="ml-auto flex items-center gap-3">
            <div id="authStatus" class="text-sm text-gray-600 dark:text-gray-400"></div>
            <button id="logoutBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800 hidden">–í—ã–π—Ç–∏</button>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-4xl px-4 py-4">
      <section id="loginCard" class="mt-2">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="max-w-md rounded-xl border border-gray-200 bg-white p-3 shadow-md dark:border-gray-800 dark:bg-gray-950">
          <h2 class="mb-3 text-lg font-medium">–ê–∫–∫–∞—É–Ω—Ç</h2>
          <div class="mb-2 inline-flex items-center gap-1 rounded-md bg-gray-100 p-1 dark:bg-gray-800/50">
            <button id="authTabLogin" type="button" aria-pressed="true" class="inline-flex items-center rounded-md px-3 py-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white dark:text-gray-300 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–í—Ö–æ–¥</button>
            <button id="authTabRegister" type="button" aria-pressed="false" class="inline-flex items-center rounded-md px-3 py-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white dark:text-gray-300 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>
          <div id="authPanels" class="mt-2 min-h-[280px]">
          <div id="loginPanel" class="grid gap-3 w-full max-w-md">
            <div>
              <label for="usernameInput" class="mb-0.5 block text-sm font-medium">–õ–æ–≥–∏–Ω</label>
              <input id="usernameInput" type="text" autocomplete="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" class="w-full h-8 rounded-md border border-gray-300 bg-white px-2 text-[13px] placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition dark:border-gray-700 dark:bg-gray-900" />
            </div>
            <div>
              <label for="passwordInput" class="mb-0.5 block text-sm font-medium">–ü–∞—Ä–æ–ª—å</label>
              <div class="relative">
                <input id="passwordInput" type="password" autocomplete="current-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full h-8 rounded-md border border-gray-300 bg-white pr-9 px-2 text-[13px] placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition dark:border-gray-700 dark:bg-gray-900" />
                <button type="button" data-toggle-password="passwordInput" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                  <span class="text-[18px]" aria-hidden="true">üëÅÔ∏è</span>
                </button>
              </div>
            </div>
          </div>
          <div id="loginActions" class="mt-3 flex flex-wrap items-center gap-2">
            <button id="loginBtn" class="inline-flex items-center gap-2 rounded-md bg-gray-900 px-2 py-1.5 text-sm font-medium text-white hover:bg-black/80 dark:bg-white dark:text-gray-900 dark:hover:bg-white/90">–í–æ–π—Ç–∏</button>
          </div>
          <div id="registerPanel" class="hidden">
            <div class="grid gap-3 w-full max-w-md">
              <div>
                <label for="regUsernameInput" class="mb-0.5 block text-sm font-medium">–õ–æ–≥–∏–Ω</label>
                <input id="regUsernameInput" type="text" autocomplete="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" class="w-full h-8 rounded-md border border-gray-300 bg-white px-2 text-[13px] placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition dark:border-gray-700 dark:bg-gray-900" />
              </div>
              <div>
                <label for="regPasswordInput" class="mb-0.5 block text-sm font-medium">–ü–∞—Ä–æ–ª—å</label>
                <div class="relative">
                  <input id="regPasswordInput" type="password" autocomplete="new-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full h-8 rounded-md border border-gray-300 bg-white pr-9 px-2 text-[13px] placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition dark:border-gray-700 dark:bg-gray-900" />
                  <button type="button" data-toggle-password="regPasswordInput" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <span class="text-[18px]" aria-hidden="true">üëÅÔ∏è</span>
                  </button>
                </div>
              </div>
              <div id="regPassword2Row" class="hidden">
                <label for="regPassword2Input" class="mb-0.5 block text-sm font-medium">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                <div class="relative">
                  <input id="regPassword2Input" type="password" autocomplete="new-password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full h-8 rounded-md border border-gray-300 bg-white pr-9 px-2 text-[13px] placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition dark:border-gray-700 dark:bg-gray-900" />
                  <button type="button" data-toggle-password="regPassword2Input" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <span class="text-[18px]" aria-hidden="true">üëÅÔ∏è</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <button id="registerBtn" class="inline-flex items-center gap-2 rounded-md bg-gray-900 px-2 py-1.5 text-sm font-medium text-white hover:bg-black/80 dark:bg-white dark:text-gray-900 dark:hover:bg-white/90">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
          </div>
          </div>
          </div>
          <div class="rounded-xl border border-gray-200 bg-white p-3 shadow-md dark:border-gray-800 dark:bg-gray-950">
            <h2 class="mb-3 text-lg font-medium">–û–ø–∏—Å–∞–Ω–∏–µ</h2>
            <p class="text-sm text-gray-700 dark:text-gray-300">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –æ—Ç—á—ë—Ç–æ–º –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å 24 ‚Äî –º—ã –ø–æ—Å—á–∏—Ç–∞–µ–º —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø–æ–∫–∞–∂–µ–º –¥–∞—à–±–æ—Ä–¥—ã. –î–∞–Ω–Ω—ã–µ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>
            <div class="mt-3 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-3 text-center text-xs text-gray-500 dark:border-gray-700 dark:bg-gray-900/40 dark:text-gray-400">–ó–∞–≥–ª—É—à–∫–∞ –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/—Å–∫—Ä–∏–Ω—à–æ—Ç</div>
          </div>
        </div>
      </section>
      <section class="mt-2">
        <div id="uploadCard" class="rounded-xl border border-gray-200 bg-white p-3 shadow-md dark:border-gray-800 dark:bg-gray-950">
          <h2 class="mb-3 text-lg font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h2>
          <div class="space-y-3">
            <div id="dropzone" class="group relative flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50/50 p-6 text-center transition hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900/50 dark:hover:bg-gray-900">
              <svg aria-hidden="true" viewBox="0 0 24 24" class="h-10 w-10 text-gray-400 dark:text-gray-500">
                <path fill="currentColor" d="M12 3a1 1 0 0 1 1 1v8.586l2.293-2.293a1 1 0 1 1 1.414 1.414L12 16.414l-3.707-3.707a1 1 0 1 1 1.414-1.414L11 12.586V4a1 1 0 0 1 1-1Z"/>
                <path fill="currentColor" d="M4 18a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H5a1 1 0 0 1-1-1Z"/>
              </svg>
              <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">
                –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ HTML/.xls —Å—é–¥–∞ –∏–ª–∏ <label for="fileInput" class="cursor-pointer underline">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
              </p>
              <input id="fileInput" type="file" accept=".html,.htm,.xls" class="sr-only" />
            </div>
            <div id="fileMeta" class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-900/50 p-2 rounded"></div>
            <div class="flex items-center gap-2">
              <button id="parseFileBtn" disabled class="inline-flex items-center gap-2 rounded-md bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black/80 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-white dark:text-gray-900 dark:hover:bg-white/90">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
              <button id="clearFileBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á—ë—Ç –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å 24.</p>
          </div>
        </div>
      </section>

      <!-- Filters first -->
      <section id="filtersTopCard" class="mt-6 hidden rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-800 dark:bg-gray-950">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-medium">–§–∏–ª—å—Ç—Ä—ã</h2>
          <div class="flex items-center gap-2">
            <button id="resetFilters" class="text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200">–°–±—Ä–æ—Å–∏—Ç—å</button>
            <button id="filtersToggle" title="–°–≤–µ—Ä–Ω—É—Ç—å" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å" class="inline-flex h-6 w-6 items-center justify-center rounded-md border border-gray-300 bg-white text-xs font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">‚ñº</button>
          </div>
        </div>
        <div class="mt-3" id="filtersBody">
          <div id="filtersCloneMount"></div>
        </div>
      </section>

      <!-- Dashboards chooser -->
      <section id="dashboardsPanel" class="mt-4 hidden rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-800 dark:bg-gray-950">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-lg font-medium">–í—ã–±–æ—Ä –¥–∞—à–±–æ—Ä–¥–∞</h2>
        </div>
        <div class="mt-3 flex flex-wrap gap-2" id="dashboardsButtons">
          <button type="button" data-dashboard="table" aria-pressed="true" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á</button>
          <button type="button" data-dashboard="companies" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–ü–æ –∫–æ–º–ø–∞–Ω–∏—è–º</button>
          <button type="button" data-dashboard="assignees" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–ü–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º</button>
          <button type="button" data-dashboard="timeline" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–∞—Ç–∞–º</button>
           <button type="button" data-dashboard="employees-tags" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (—Ç–µ–≥–∏)</button>
          <button type="button" data-dashboard="data-quality" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö</button>
          <button type="button" data-dashboard="tags" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–ß–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å —Ç–µ–≥–æ–≤</button>
          <button type="button" data-dashboard="company-duration" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</button>
          <button type="button" data-dashboard="assignee-duration" aria-pressed="false" class="inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm font-medium select-none transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:hover:bg-gray-800 aria-[pressed=true]:bg-gray-900 aria-[pressed=true]:text-white aria-[pressed=true]:border-transparent aria-[pressed=true]:hover:bg-gray-900 aria-[pressed=true]:dark:bg-white aria-[pressed=true]:dark:text-gray-900">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º</button>
        </div>
        <div id="dashboardContent" class="mt-4"></div>
      </section>

      <section id="mappingSection" class="mt-6 hidden rounded-xl border border-amber-300 bg-amber-50 p-4 text-amber-900 dark:border-amber-700 dark:bg-amber-950/40 dark:text-amber-200">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h3 class="text-base font-semibold">–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫</h3>
            <p class="mt-1 text-sm opacity-90">–ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è–º.</p>
          </div>
          <button id="hideMapping" class="rounded-md px-2 py-1 text-sm hover:bg-amber-100/60 dark:hover:bg-amber-900/30">‚úï</button>
        </div>
        <div id="mappingControls" class="mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-4"></div>
        <div class="mt-3">
          <button id="applyMappingBtn" class="rounded-md bg-amber-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-amber-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </section>

      <section id="resultsCard" class="mt-6 hidden rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-800 dark:bg-gray-950">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-lg font-medium">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
          <div class="flex items-center gap-2">
            <div id="stats" class="text-sm text-gray-600 dark:text-gray-400"></div>
            <button id="openColumnsSettings" aria-label="–í—ã–±—Ä–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏" class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white p-1.5 text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 dark:hover:bg-gray-800">
              <span aria-hidden="true" class="text-[18px] leading-none">‚öôÔ∏é</span>
            </button>
          </div>
        </div>
        <div id="filtersCard" class="hidden">
          <div id="filters">
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label for="createdRange" class="mb-1 block text-sm font-medium">–°–æ–∑–¥–∞–Ω–æ (–ø–µ—Ä–∏–æ–¥)</label>
              <input id="createdRange" type="text" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥ ‚Äî –¥–¥.–º–º.–≥–≥–≥–≥" class="w-full rounded-md border border-gray-300 bg-white p-1.5 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:border-gray-700 dark:bg-gray-900" />
              <input id="createdFrom" type="date" class="hidden" />
              <input id="createdTo" type="date" class="hidden" />
            </div>
            <div>
              <label for="completedRange" class="mb-1 block text-sm font-medium">–ó–∞–≤–µ—Ä—à–µ–Ω–æ (–ø–µ—Ä–∏–æ–¥)</label>
              <input id="completedRange" type="text" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥ ‚Äî –¥–¥.–º–º.–≥–≥–≥–≥" class="w-full rounded-md border border-gray-300 bg-white p-1.5 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:border-gray-700 dark:bg-gray-900" />
              <input id="completedFrom" type="date" class="hidden" />
              <input id="completedTo" type="date" class="hidden" />
            </div>
          </div>
          <div class="mt-3 grid gap-3 sm:grid-cols-2">
            <div>
              <div class="mb-2 flex items-center gap-2">
                <label class="text-sm font-medium">–ò—Å–∫–ª—é—á–∏—Ç—å</label>
                <button id="excludeEditBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="ml-auto inline-flex h-6 w-6 items-center justify-center rounded-md border border-gray-300 bg-white text-xs font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">‚úé</button>
                <button id="addExcludeTerm" class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-gray-300 bg-white text-sm font-medium leading-none hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">+</button>
              </div>
              <div id="excludeChips" class="flex w-full flex-wrap items-center gap-2 rounded-md border border-gray-300 bg-gray-50 p-1.5 min-h-[32px] max-h-32 overflow-y-auto cursor-default select-none dark:border-gray-700 dark:bg-gray-900"></div>
              <input id="filterExclude" type="text" placeholder="–ò—Å–∫–ª—é—á–∏—Ç—å: —Ç–µ—Ä–º–∏–Ω—ã" class="hidden w-full rounded-md border border-gray-300 bg-white p-1.5 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:border-gray-700 dark:bg-gray-900" />
            </div>
            <div>
              <div class="mb-2 flex items-center gap-2">
                <label class="text-sm font-medium">–í–∫–ª—é—á–∏—Ç—å</label>
                <button id="includeEditBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="ml-auto inline-flex h-6 w-6 items-center justify-center rounded-md border border-gray-300 bg-white text-xs font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">‚úé</button>
                <button id="addIncludeTerm" class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-gray-300 bg-white text-sm font-medium leading-none hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">+</button>
              </div>
              <div id="includeChips" class="flex w-full flex-wrap items-center gap-2 rounded-md border border-gray-300 bg-gray-50 p-1.5 min-h-[32px] max-h-32 overflow-y-auto cursor-default select-none dark:border-gray-700 dark:bg-gray-900"></div>
              <input id="filterQuery" type="text" placeholder="–í–∫–ª—é—á–∏—Ç—å: —Å–ª–æ–≤–∞, \"—Ç–æ—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã\", –ø—Ä–µ—Ñ–∏–∫—Å—ã*" class="hidden w-full rounded-md border border-gray-300 bg-white p-1.5 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:border-gray-700 dark:bg-gray-900" />
            </div>
          </div>
          <div class="mt-3 grid gap-3 sm:grid-cols-2">
            <div>
              <div class="mb-2 flex items-center gap-2">
                <label class="text-sm font-medium">–ú–æ–∏ –∑–∞–∫–ª–∞–¥–∫–∏</label>
                <button id="personalBookmarkEditBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="ml-auto inline-flex h-6 w-6 items-center justify-center rounded-md border border-gray-300 bg-white text-xs font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">‚úé</button>
                <button id="personalBookmarkAddBtn" class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-gray-300 bg-white text-sm font-medium leading-none hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">+</button>
              </div>
              <div id="personalBookmarksChips" class="flex w-full flex-wrap items-center gap-2 rounded-md border border-gray-300 bg-gray-50 p-1.5 min-h-[32px] max-h-32 overflow-y-auto cursor-default select-none dark:border-gray-700 dark:bg-gray-900"></div>
            </div>
            <div>
              <div class="mb-2 flex items-center gap-2">
                <label class="text-sm font-medium">–û–±—â–∏–µ –∑–∞–∫–ª–∞–¥–∫–∏</label>
                <button id="sharedBookmarkEditBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="ml-auto inline-flex h-6 w-6 items-center justify-center rounded-md border border-gray-300 bg-white text-xs font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">‚úé</button>
                <button id="sharedBookmarkAddBtn" class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-gray-300 bg-white text-sm font-medium leading-none hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900">+</button>
              </div>
              <div id="sharedBookmarksChips" class="flex w-full flex-wrap items-center gap-2 rounded-md border border-gray-300 bg-gray-50 p-1.5 min-h-[32px] max-h-32 overflow-y-auto cursor-default select-none dark:border-gray-700 dark:bg-gray-900"></div>
            </div>
            <div class="sm:col-span-2 lg:col-span-3 hidden">
              <input id="bmNameInput" type="text" class="hidden" />
              <button id="saveBookmarkBtn" class="hidden">save</button>
              <select id="bookmarksSelect" class="hidden"></select>
              <button id="deleteBookmarkBtn" class="hidden">del</button>
            </div>
          </div>
          </div>
        </div>
        <div class="mt-3 overflow-x-auto">
          <table id="resultsTable" class="min-w-full table-fixed divide-y divide-gray-200 text-sm dark:divide-gray-800">
            <colgroup id="resultsColGroup"></colgroup>
            <thead class="bg-gray-50 dark:bg-gray-900">
              <tr id="resultsHeadRow"></tr>
            </thead>
            <tbody id="resultsBody" class="divide-y divide-gray-200 dark:divide-gray-800 [word-break:break-word]"></tbody>
          </table>
        </div>
      </section>

      <!-- Details Modal -->
      <div id="detailsModal" class="fixed inset-0 z-50 hidden">
        <div id="detailsBackdrop" class="absolute inset-0 bg-black/50"></div>
        <div class="absolute inset-0 flex items-start justify-center p-4 sm:p-6">
          <div class="mt-10 w-full max-w-3xl overflow-hidden rounded-xl border border-gray-200 bg-white shadow-lg dark:border-gray-800 dark:bg-gray-950">
            <div class="flex items-center justify-between border-b border-gray-200 p-4 dark:border-gray-800">
              <h3 id="detailsTitle" class="truncate text-base font-semibold">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h3>
              <button id="detailsCloseBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
            <div id="detailsContent" class="max-h-[70vh] overflow-y-auto p-4"></div>
          </div>
        </div>
      </div>

      <!-- Settings Modal -->
      <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div id="settingsBackdrop" class="absolute inset-0 bg-black/50"></div>
        <div class="absolute inset-0 flex items-start justify-center p-4 sm:p-6">
          <div class="mt-10 w-full max-w-lg overflow-hidden rounded-xl border border-gray-200 bg-white shadow-lg dark:border-gray-800 dark:bg-gray-950">
            <div class="flex items-center justify-between border-b border-gray-200 p-4 dark:border-gray-800">
              <h3 class="truncate text-base font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞</h3>
              <div class="flex items-center gap-2">
                <button id="settingsSaveBtn" class="inline-flex items-center gap-2 rounded-md bg-gray-900 px-2 py-1.5 text-sm font-medium text-white hover:bg-black/80 dark:bg-white dark:text-gray-900 dark:hover:bg-white/90">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="settingsCloseBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
            <div class="max-h-[70vh] overflow-y-auto p-4">
              <div class="space-y-3">
                <div>
                  <label for="tagsKeywordsInput" class="mb-1 block text-sm font-medium">–°–ª–æ–≤–∞ –≤ —Ç–µ–≥–∞—Ö</label>
                  <input id="tagsKeywordsInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –±–∞–≥, —Å—Ä–æ—á–Ω–æ" class="w-full rounded-md border border-gray-300 bg-white p-1.5 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:border-gray-700 dark:bg-gray-900" />
                  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –ë—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã –∑–∞–¥–∞—á–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤ –∫–æ–ª–æ–Ω–∫–µ ¬´–¢–µ–≥–∏¬ª –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —ç—Ç–∏ —Å–ª–æ–≤–∞.</p>
                </div>
                <div>
                  <label for="tagsModeSelect" class="mb-1 block text-sm font-medium">–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ</label>
                  <select id="tagsModeSelect" class="w-full rounded-md border border-gray-300 bg-white p-1.5 text-sm dark:border-gray-700 dark:bg-gray-900">
                    <option value="any">–õ—é–±–æ–µ –∏–∑ —Å–ª–æ–≤</option>
                    <option value="all">–í—Å–µ —Å–ª–æ–≤–∞</option>
                  </select>
                </div>
                <hr class="my-2 border-gray-200 dark:border-gray-800" />
                <div>
                  <div class="mb-1 flex items-center justify-between">
                    <label class="block text-sm font-medium">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (—Ñ–∞–º–∏–ª–∏–∏)</label>
                    <button id="applyEmployeesFilterBtn" class="rounded-md border border-gray-300 bg-white px-2 py-1 text-xs font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                  </div>
                  <div class="flex gap-2">
                    <input id="employeeInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤" class="w-full rounded-md border border-gray-300 bg-white p-1.5 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:border-gray-700 dark:bg-gray-900" />
                    <button id="addEmployeeBtn" class="shrink-0 rounded-md bg-gray-900 px-2 py-1.5 text-sm font-medium text-white hover:bg-black/80 dark:bg-white dark:text-gray-900 dark:hover:bg-white/90">+</button>
                  </div>
                  <div id="employeesList" class="mt-2 flex flex-wrap gap-2"></div>
                  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ñ–∞–º–∏–ª–∏–∏ –ø–æ –æ–¥–Ω–æ–π. –ö–Ω–æ–ø–∫–∞ –≤—ã—à–µ –ø—Ä–∏–º–µ–Ω–∏—Ç —Ñ–∏–ª—å—Ç—Ä –∑–∞–¥–∞—á, –≥–¥–µ –≤ —Ç–µ–≥–∞—Ö –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∏–∑ —Ñ–∞–º–∏–ª–∏–π.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Columns Settings Modal -->
      <div id="columnsModal" class="fixed inset-0 z-50 hidden">
        <div id="columnsBackdrop" class="absolute inset-0 bg-black/50"></div>
        <div class="absolute inset-0 flex items-start justify-center p-4 sm:p-6">
          <div class="mt-10 w-full max-w-md overflow-hidden rounded-xl border border-gray-200 bg-white shadow-lg dark:border-gray-800 dark:bg-gray-950">
            <div class="flex items-center justify-between border-b border-gray-200 p-4 dark:border-gray-800">
              <h3 class="truncate text-base font-semibold">–ö–æ–ª–æ–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—ã</h3>
              <div class="flex items-center gap-2">
                <button id="columnsSaveBtn" class="inline-flex items-center gap-2 rounded-md bg-gray-900 px-2 py-1.5 text-sm font-medium text-white hover:bg-black/80 dark:bg-white dark:text-gray-900 dark:hover:bg-white/90">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="columnsCloseBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm font-medium hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
            <div class="max-h-[70vh] overflow-y-auto p-4">
              <p class="mb-2 text-xs text-gray-500 dark:text-gray-400">–û—Ç–º–µ—Ç—å—Ç–µ, –∫–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å. –ü–æ—Ä—è–¥–æ–∫ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å, –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—è –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ.</p>
              <div id="columnsList" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>

      <section id="message" class="mt-6 hidden rounded-md border p-4 text-sm"></section>
    </main>

    <footer class="mt-10 border-t border-gray-200 py-8 text-center text-xs text-gray-600 dark:border-gray-800 dark:text-gray-400">
      <div class="mx-auto max-w-5xl px-4">
        <div class="mx-auto flex max-w-md items-center gap-3 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-900/40">
          <div class="h-10 w-10 shrink-0 rounded bg-gray-200 dark:bg-gray-800"></div>
          <div class="text-left">
            <div class="font-medium">–¢–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–∫-–∑–∞–≥–ª—É—à–∫–∞</div>
            <div class="mt-0.5 text-[13px] text-gray-500 dark:text-gray-400">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.</div>
          </div>
        </div>
      </div>
    </footer>

    <script>
      const fileInput = document.getElementById('fileInput');
      const dropzone = document.getElementById('dropzone');
      const fileMeta = document.getElementById('fileMeta');
      const parseFileBtn = document.getElementById('parseFileBtn');
      const clearFileBtn = document.getElementById('clearFileBtn');
      const loginCard = document.getElementById('loginCard');
      const usernameInput = document.getElementById('usernameInput');
      const passwordInput = document.getElementById('passwordInput');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const authStatus = document.getElementById('authStatus');
      const resultsCard = document.getElementById('resultsCard');
      const resultsBody = document.getElementById('resultsBody');
      const resultsTable = document.getElementById('resultsTable');
      const resultsHeadRow = document.getElementById('resultsHeadRow');
      const resultsColGroup = document.getElementById('resultsColGroup');
      const stats = document.getElementById('stats');
      const message = document.getElementById('message');
      const mappingSection = document.getElementById('mappingSection');
      const mappingControls = document.getElementById('mappingControls');
      const applyMappingBtn = document.getElementById('applyMappingBtn');
      const hideMappingBtn = document.getElementById('hideMapping');
       const uploadCard = document.getElementById('uploadCard');
       const dashboardsPanel = document.getElementById('dashboardsPanel');
       const dashboardContent = document.getElementById('dashboardContent');

      // Details modal UI
      const detailsModal = document.getElementById('detailsModal');
      const detailsBackdrop = document.getElementById('detailsBackdrop');
      const detailsCloseBtn = document.getElementById('detailsCloseBtn');
      const detailsTitle = document.getElementById('detailsTitle');
      const detailsContent = document.getElementById('detailsContent');
      // Settings modal UI
      const settingsModal = document.getElementById('settingsModal');
      const settingsBackdrop = document.getElementById('settingsBackdrop');
      const settingsCloseBtn = document.getElementById('settingsCloseBtn');
      const settingsSaveBtn = document.getElementById('settingsSaveBtn');
      const openFilterSettingsBtn = document.getElementById('openFilterSettings');
      const tagsKeywordsInput = document.getElementById('tagsKeywordsInput');
      const tagsModeSelect = document.getElementById('tagsModeSelect');
      const employeeInput = document.getElementById('employeeInput');
      const addEmployeeBtn = document.getElementById('addEmployeeBtn');
      const employeesList = document.getElementById('employeesList');
      const applyEmployeesFilterBtn = document.getElementById('applyEmployeesFilterBtn');

      // Columns settings UI
      const openColumnsSettingsBtn = document.getElementById('openColumnsSettings');
      const columnsModal = document.getElementById('columnsModal');
      const columnsBackdrop = document.getElementById('columnsBackdrop');
      const columnsCloseBtn = document.getElementById('columnsCloseBtn');
      const columnsSaveBtn = document.getElementById('columnsSaveBtn');
      const columnsList = document.getElementById('columnsList');

      // Filters UI
      const filterQuery = document.getElementById('filterQuery');
      const createdFromInput = document.getElementById('createdFrom');
      const createdToInput = document.getElementById('createdTo');
      const completedFromInput = document.getElementById('completedFrom');
      const completedToInput = document.getElementById('completedTo');
      const createdRangeInput = document.getElementById('createdRange');
      const completedRangeInput = document.getElementById('completedRange');
      const resetFiltersBtn = document.getElementById('resetFilters');
      // Bookmarks UI
      const bmNameInput = document.getElementById('bmNameInput');
      const saveBookmarkBtn = document.getElementById('saveBookmarkBtn');
      const bookmarksSelect = document.getElementById('bookmarksSelect');
      const deleteBookmarkBtn = document.getElementById('deleteBookmarkBtn');

      let lastParsedHeaders = [];
      let lastParsedRows = [];
      let suggestedMapping = { id: -1, title: -1, company: -1, assignee: -1, created: -1, completed: -1, duration: -1, tags: -1 };
      let allTasks = [];
      let bookmarks = [];
       let currentDashboard = 'table';
       let lastFilteredTasks = [];
      let personalBookmarks = [];
      let filterSettings = {
        tagsKeywords: [],
        tagsMode: 'any',
        employees: []
      };

      // Columns state
      const ALL_COLUMNS = [
        { key: 'id', label: 'ID' },
        { key: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ' },
        { key: 'description', label: '–û–ø–∏—Å–∞–Ω–∏–µ (–∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã)' },
        { key: 'company', label: '–ö–æ–º–ø–∞–Ω–∏—è' },
        { key: 'assignee', label: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' },
        { key: 'created', label: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è' },
        { key: 'completed', label: '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è' },
        { key: 'duration', label: '–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è' },
        { key: 'tags', label: '–¢–µ–≥–∏' }
      ];
      const DEFAULT_COLUMNS = ALL_COLUMNS.map((c) => c.key);
      const COLS_STORAGE_KEY = 'task_table_visible_columns_v1';
      let visibleColumns = [];
      const COL_WIDTHS_STORAGE_KEY = 'task_table_column_widths_v1';
      let columnWidths = {}; // { key: number(px) }

      function loadVisibleColumns() {
        try {
          const raw = localStorage.getItem(COLS_STORAGE_KEY);
          const arr = raw ? JSON.parse(raw) : null;
          const valid = Array.isArray(arr) ? arr.filter((k) => ALL_COLUMNS.some((c) => c.key === k)) : [];
          visibleColumns = valid.length ? valid : [...DEFAULT_COLUMNS];
        } catch (_) {
          visibleColumns = [...DEFAULT_COLUMNS];
        }
      }
      function saveVisibleColumns() {
        try { localStorage.setItem(COLS_STORAGE_KEY, JSON.stringify(visibleColumns)); } catch (_) {}
      }

      function getColumnLabel(key) {
        if (String(key).startsWith('rawidx:')) {
          const idx = Number(String(key).slice('rawidx:'.length));
          const label = (lastParsedHeaders?.[idx] ?? '').toString().trim();
          return label || `–ö–æ–ª–æ–Ω–∫–∞ ${idx + 1}`;
        }
        const c = ALL_COLUMNS.find((x) => x.key === key);
        return c ? c.label : key;
      }

      function getSelectableColumns() {
        const base = [...ALL_COLUMNS];
        const norm = (s) => (s || '').toString().trim().toLowerCase();
        const baseLabelSet = new Set(base.map((c) => norm(c.label)));
        const seen = new Map();
        // Append all raw headers from the last parsed table with clear labels
        if (Array.isArray(lastParsedHeaders) && lastParsedHeaders.length) {
          lastParsedHeaders.forEach((h, i) => {
            const raw = (h ?? '').toString().trim();
            let display = raw || `–ö–æ–ª–æ–Ω–∫–∞ ${i + 1}`;
            if (baseLabelSet.has(norm(display))) {
              display = `${display} (–∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã)`;
            }
            const key = `rawidx:${i}`;
            const k = norm(display);
            const prev = seen.get(k) || 0;
            seen.set(k, prev + 1);
            if (prev > 0) {
              display = `${display} (–∫–æ–ª–æ–Ω–∫–∞ ${i + 1})`;
            }
            base.push({ key, label: display });
          });
        }
        return base;
      }

      function renderColumnsList() {
        if (!columnsList) return;
        columnsList.innerHTML = '';
        const frag = document.createDocumentFragment();
        const items = getSelectableColumns();
        items.forEach((c) => {
          const row = document.createElement('label');
          row.className = 'flex items-center gap-2';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = c.key;
          cb.checked = visibleColumns.includes(c.key);
          cb.className = 'h-4 w-4';
          const span = document.createElement('span');
          span.textContent = c.label;
          row.appendChild(cb);
          row.appendChild(span);
          frag.appendChild(row);
        });
        columnsList.appendChild(frag);
      }

      function openColumnsSettings() {
        renderColumnsList();
        if (columnsModal) columnsModal.classList.remove('hidden');
      }
      function closeColumnsSettings() {
        if (columnsModal) columnsModal.classList.add('hidden');
      }

      function applyColumnsSettingsFromModal() {
        if (!columnsList) return;
        const checked = Array.from(columnsList.querySelectorAll('input[type="checkbox"]'))
          .filter((el) => el.checked)
          .map((el) => el.value);
        if (!checked.length) {
          // Do not allow empty configuration; keep previous
          closeColumnsSettings();
          return;
        }
        // Preserve current order for kept columns, append new ones by DEFAULT order
        const preserved = visibleColumns.filter((k) => checked.includes(k));
        const allOrder = getSelectableColumns().map((c) => c.key);
        const toAppend = allOrder.filter((k) => checked.includes(k) && !preserved.includes(k));
        visibleColumns = [...preserved, ...toAppend];
        saveVisibleColumns();
        // Re-render table
        applyFilters();
        closeColumnsSettings();
      }

      function createHeaderCell(key) {
        const th = document.createElement('th');
        th.className = 'relative px-3 py-2 text-left font-semibold select-none cursor-move whitespace-nowrap';
        const label = document.createElement('span');
        label.className = 'block truncate pr-1';
        label.textContent = getColumnLabel(key);
        th.appendChild(label);
        const resizer = document.createElement('div');
        resizer.className = 'absolute right-0 top-0 h-full w-2 cursor-col-resize select-none hover:bg-gray-300/60 dark:hover:bg-gray-600/30';
        resizer.setAttribute('data-resizer', '');
        th.appendChild(resizer);
        th.setAttribute('data-col-key', key);
        th.setAttribute('draggable', 'true');
        const w = Number(columnWidths?.[key]);
        if (Number.isFinite(w) && w > 24) {
          th.style.width = w + 'px';
          th.style.minWidth = w + 'px';
          th.style.maxWidth = w + 'px';
        }
        return th;
      }

      function renderTableHeader() {
        if (!resultsHeadRow) return;
        resultsHeadRow.innerHTML = '';
        const frag = document.createDocumentFragment();
        visibleColumns.forEach((k) => frag.appendChild(createHeaderCell(k)));
        resultsHeadRow.appendChild(frag);
        initHeaderDragAndDrop();
        initHeaderResizers();
        renderColGroup();
      }

      function renderColGroup() {
        if (!resultsColGroup) return;
        resultsColGroup.innerHTML = '';
        const frag = document.createDocumentFragment();
        visibleColumns.forEach((key) => {
          const col = document.createElement('col');
          const w = Number(columnWidths?.[key]);
          if (Number.isFinite(w) && w > 24) {
            col.style.width = w + 'px';
          } else {
            col.removeAttribute('style');
          }
          frag.appendChild(col);
        });
        resultsColGroup.appendChild(frag);
      }

      function initHeaderDragAndDrop() {
        if (!resultsHeadRow) return;
        const ths = Array.from(resultsHeadRow.querySelectorAll('th[data-col-key]'));
        let dragIndex = -1;
        ths.forEach((th, idx) => {
          th.addEventListener('dragstart', (e) => {
            if (e.target && e.target.getAttribute && e.target.getAttribute('data-resizer') !== null) {
              e.preventDefault();
              return;
            }
            dragIndex = idx;
            e.dataTransfer?.setData('text/plain', String(idx));
            th.classList.add('opacity-60');
          });
          th.addEventListener('dragend', () => {
            th.classList.remove('opacity-60');
            dragIndex = -1;
          });
          th.addEventListener('dragover', (e) => {
            e.preventDefault();
          });
          th.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetTh = e.currentTarget;
            const toIndex = ths.indexOf(targetTh);
            const fromIndex = dragIndex;
            if (fromIndex === -1 || toIndex === -1 || fromIndex === toIndex) return;
            const moved = visibleColumns.splice(fromIndex, 1)[0];
            visibleColumns.splice(toIndex, 0, moved);
            saveVisibleColumns();
            renderTableHeader();
            // re-render rows to match order
            applyFilters();
          });
        });
      }

      function loadColumnWidths() {
        try {
          const raw = localStorage.getItem(COL_WIDTHS_STORAGE_KEY);
          const obj = raw ? JSON.parse(raw) : {};
          columnWidths = obj && typeof obj === 'object' ? obj : {};
        } catch (_) {
          columnWidths = {};
        }
      }
      function saveColumnWidths() {
        try { localStorage.setItem(COL_WIDTHS_STORAGE_KEY, JSON.stringify(columnWidths)); } catch (_) {}
      }

      function updateTableColumnWidth(colKey, widthPx) {
        if (!resultsHeadRow) return;
        // header
        const th = resultsHeadRow.querySelector(`th[data-col-key="${colKey}"]`);
        if (th) {
          th.style.width = widthPx + 'px';
          th.style.minWidth = widthPx + 'px';
          th.style.maxWidth = widthPx + 'px';
        }
        // colgroup
        if (resultsColGroup) {
          const idx = visibleColumns.indexOf(colKey);
          const col = resultsColGroup.children?.[idx];
          if (col) col.style.width = widthPx + 'px';
        }
        // body cells by index
        const idx = visibleColumns.indexOf(colKey);
        if (idx >= 0) {
          const rows = resultsBody?.children ? Array.from(resultsBody.children) : [];
          for (const tr of rows) {
            const td = tr.children?.[idx];
            if (td) {
              td.style.width = widthPx + 'px';
              td.style.minWidth = widthPx + 'px';
              td.style.maxWidth = widthPx + 'px';
            }
          }
        }
      }

      function initHeaderResizers() {
        if (!resultsHeadRow) return;
        const ths = Array.from(resultsHeadRow.querySelectorAll('th[data-col-key]'));
        ths.forEach((th) => {
          const key = th.getAttribute('data-col-key');
          const handle = th.querySelector('[data-resizer]');
          if (!handle) return;
          let startX = 0;
          let startWidth = 0;
          const onMouseMove = (e) => {
            const dx = e.clientX - startX;
            const w = Math.max(60, startWidth + dx);
            updateTableColumnWidth(key, w);
          };
          const onMouseUp = (e) => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            const thWidth = th.getBoundingClientRect().width;
            const w = Math.max(60, Math.round(thWidth));
            columnWidths[key] = w;
            saveColumnWidths();
          };
          handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            startX = e.clientX;
            startWidth = th.getBoundingClientRect().width;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          });
        });
      }

      // Auth helpers
      const AUTH_STORAGE_KEY = 'task_table_auth_v1';
      const ACCOUNTS_STORAGE_KEY = 'task_table_accounts_v1'; // legacy (migration only)
      const IDB_DB_NAME = 'task_table_auth_db_v1';
      const IDB_STORE = 'accounts';
      const PBKDF2_ITERATIONS = 150000;
      const PBKDF2_SALT_BYTES = 16;
      const PBKDF2_HASH_BYTES = 32;
      let currentAuth = null;

      function loadAuth() {
        try {
          const raw = localStorage.getItem(AUTH_STORAGE_KEY);
          const obj = raw ? JSON.parse(raw) : null;
          if (obj && typeof obj === 'object' && obj.username) {
            currentAuth = obj;
          } else {
            currentAuth = null;
          }
        } catch (_) {
          currentAuth = null;
        }
      }
      async function refreshAuthFromServer() {
        try {
          const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
          if (res.ok) {
            const data = await res.json();
            currentAuth = { username: data?.username, savedAt: Date.now() };
            saveAuth(currentAuth);
          } else {
            clearAuth();
          }
        } catch (_) {
          // Network error: keep local state as-is
        }
      }

      async function serverLogin(username, password) {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error(await res.text() || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        const data = await res.json();
        return data;
      }

      async function serverRegister(username, password) {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error(await res.text() || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        const data = await res.json();
        return data;
      }

      async function serverLogout() {
        try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' }); } catch (_) {}
      }

      function saveAuth(auth) {
        try {
          localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(auth));
        } catch (_) {}
      }

      function clearAuth() {
        try { localStorage.removeItem(AUTH_STORAGE_KEY); } catch (_) {}
        currentAuth = null;
      }

      // IndexedDB helpers
      function openAuthDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(IDB_DB_NAME, 1);
          req.onerror = () => reject(req.error);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(IDB_STORE)) {
              const store = db.createObjectStore(IDB_STORE, { keyPath: 'usernameLower' });
              store.createIndex('usernameLower', 'usernameLower', { unique: true });
            }
          };
          req.onsuccess = () => resolve(req.result);
        });
      }

      async function idbGetAccount(username) {
        const db = await openAuthDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, 'readonly');
          const store = tx.objectStore(IDB_STORE);
          const req = store.get(String(username).toLowerCase());
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => reject(req.error);
        });
      }

      async function idbPutAccount(record) {
        const db = await openAuthDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, 'readwrite');
          const store = tx.objectStore(IDB_STORE);
          const req = store.put(record);
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });
      }

      function bytesToBase64(bytes) {
        let binary = '';
        const arr = new Uint8Array(bytes);
        for (let i = 0; i < arr.byteLength; i++) binary += String.fromCharCode(arr[i]);
        return btoa(binary);
      }
      function base64ToBytes(b64) {
        const binary = atob(b64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        return bytes;
      }

      async function derivePasswordHash(password, saltB64, iterations = PBKDF2_ITERATIONS) {
        const enc = new TextEncoder();
        const pwKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
        let salt;
        if (saltB64) {
          salt = base64ToBytes(saltB64);
        } else {
          salt = new Uint8Array(PBKDF2_SALT_BYTES);
          crypto.getRandomValues(salt);
        }
        const bits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations, hash: 'SHA-256' }, pwKey, PBKDF2_HASH_BYTES * 8);
        const hashB64 = bytesToBase64(new Uint8Array(bits));
        return { saltB64: bytesToBase64(salt), hashB64, iterations };
      }

      async function verifyPassword(password, account) {
        if (!account || !account?.hashB64 || !account?.saltB64) return false;
        const { hashB64 } = await derivePasswordHash(password, account.saltB64, account.iterations || PBKDF2_ITERATIONS);
        return hashB64 === account.hashB64;
      }

      async function migrateLegacyAccountsIfAny() {
        try {
          const rawAcc = localStorage.getItem(ACCOUNTS_STORAGE_KEY);
          const arr = rawAcc ? JSON.parse(rawAcc) : [];
          if (Array.isArray(arr) && arr.length) {
            for (const a of arr) {
              const username = a?.username;
              const password = a?.password;
              if (!username || !password) continue;
              const existing = await idbGetAccount(username);
              if (existing) continue;
              const { saltB64, hashB64, iterations } = await derivePasswordHash(password);
              await idbPutAccount({ username, usernameLower: String(username).toLowerCase(), saltB64, hashB64, iterations, createdAt: Date.now() });
            }
          }
          // Cleanup legacy storage
          try { localStorage.removeItem(ACCOUNTS_STORAGE_KEY); } catch (_) {}
          // If legacy auth had password, drop it; keep username only
          try {
            const raw = localStorage.getItem(AUTH_STORAGE_KEY);
            const obj = raw ? JSON.parse(raw) : null;
            if (obj && obj.password) {
              delete obj.password;
              localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(obj));
            }
          } catch (_) {}
        } catch (_) {}
      }

      function isAuthenticated() {
        return !!(currentAuth && currentAuth.username);
      }

      function updateAuthStatus() {
        const loggedIn = isAuthenticated();
        if (authStatus) {
          authStatus.textContent = loggedIn ? `–í—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥: ${currentAuth.username}` : '–í—Ö–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω';
        }
        if (logoutBtn) logoutBtn.classList.toggle('hidden', !loggedIn);
        if (loginCard) loginCard.classList.toggle('hidden', loggedIn);
      }

      function applyAuthGate() {
        const loggedIn = isAuthenticated();
        if (!loggedIn) {
          if (uploadCard) uploadCard.classList.add('hidden');
          if (dashboardsPanel) dashboardsPanel.classList.add('hidden');
          const top = document.getElementById('filtersTopCard');
          if (top) top.classList.add('hidden');
          if (resultsCard) resultsCard.classList.add('hidden');
          if (mappingSection) mappingSection.classList.add('hidden');
        } else {
          // Show dashboards only when data is present; show upload otherwise
          const hasAny = Array.isArray(allTasks) && allTasks.length > 0;
          if (uploadCard) uploadCard.classList.toggle('hidden', hasAny);
          if (dashboardsPanel) dashboardsPanel.classList.toggle('hidden', !hasAny);
          const top = document.getElementById('filtersTopCard');
          if (top) top.classList.toggle('hidden', !hasAny);
        }
      }

       function setActiveDashboard(key) {
         currentDashboard = key || 'table';
         const btns = document.querySelectorAll('[data-dashboard]');
         btns.forEach((b) => {
           const isActive = b.getAttribute('data-dashboard') === currentDashboard;
           b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
         });
         const showTable = currentDashboard === 'table';
         // Show table only for "table" dashboard and when data exists
         const hasAny = Array.isArray(allTasks) && allTasks.length > 0;
         resultsCard.classList.toggle('hidden', !(showTable && hasAny));
         const top = document.getElementById('filtersTopCard');
         if (top) top.classList.toggle('hidden', !hasAny);
         renderDashboardContent();
       }

       function computeGroupedCounts(items, fieldKey) {
         const map = new Map();
         for (const t of items) {
           let raw = (t?.[fieldKey] ?? '').toString().trim();
           const key = raw || '‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî';
           map.set(key, (map.get(key) || 0) + 1);
         }
         const arr = Array.from(map.entries()).map(([label, count]) => ({ label, count }));
         arr.sort((a, b) => b.count - a.count || a.label.localeCompare(b.label, 'ru'));
         return arr;
       }

        function computeEmployeeCountsByTags(items) {
          const employees = Array.isArray(filterSettings?.employees) ? filterSettings.employees.filter(Boolean) : [];
          if (!employees.length) return [];
          const normalizeToken = (s) => String(s || '')
            .toLowerCase()
            .replace(/[^A-Za-z–ê-–Ø–∞-—è–Å—ë0-9]+/g, '');
          const employeeNorms = employees.map((e) => ({ original: e, norm: normalizeToken(e) }))
            .filter((e) => e.norm);
          const countsMap = new Map();
          for (const e of employeeNorms) countsMap.set(e.original, 0);
          for (const t of items) {
            const raw = String(t?.tags || '');
            if (!raw.trim()) continue;
            const tokens = raw
              .split(/[;,.|/\\#\n\r\t\s]+/g)
              .map((s) => normalizeToken(s))
              .filter(Boolean);
            if (!tokens.length) continue;
            const tokenSet = new Set(tokens);
            for (const e of employeeNorms) {
              if (tokenSet.has(e.norm)) {
                countsMap.set(e.original, (countsMap.get(e.original) || 0) + 1);
              }
            }
          }
          const arr = Array.from(countsMap.entries()).map(([label, count]) => ({ label, count }));
          arr.sort((a, b) => b.count - a.count || a.label.localeCompare(b.label, 'ru'));
          return arr;
        }

       function renderBarList(groups, caption) {
         const max = Math.max(1, ...groups.map((g) => g.count));
         const rows = groups.map((g) => {
           const pct = Math.round((g.count / max) * 100);
           return `
             <div class="grid grid-cols-[1fr_auto] items-center gap-3">
               <div class="min-w-0">
                 <div class="truncate text-sm">${escapeHtml(g.label)}</div>
                 <div class="mt-1 h-2 w-full overflow-hidden rounded bg-gray-100 dark:bg-gray-800">
                   <div class="h-2 rounded bg-gray-900 dark:bg-white" style="width: ${pct}%"></div>
                 </div>
               </div>
               <div class="text-right text-sm tabular-nums text-gray-600 dark:text-gray-400">${g.count}</div>
             </div>
           `;
         }).join('');
         return `
           <div class="rounded-xl border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-gray-950">
             ${caption ? `<div class=\"mb-3 text-sm font-medium text-gray-700 dark:text-gray-300\">${escapeHtml(caption)}</div>` : ''}
             <div class="space-y-3">${rows || '<div class="text-sm text-gray-500 dark:text-gray-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}</div>
           </div>
         `;
       }

       function groupByMonth(items, fieldKey) {
         const counts = new Map();
         for (const t of items) {
           const ts = parseDateFromCell(t?.[fieldKey]);
           if (Number.isNaN(ts)) continue;
           const d = new Date(ts);
           const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
           counts.set(key, (counts.get(key) || 0) + 1);
         }
         const keys = Array.from(counts.keys()).sort();
         return keys.map((k) => ({ label: k, count: counts.get(k) }));
       }

       function renderTimelineDashboard(items) {
         const created = groupByMonth(items, 'created');
         const completed = groupByMonth(items, 'completed');
         const createdBlock = renderBarList(created, '–°–æ–∑–¥–∞–Ω–æ –ø–æ –º–µ—Å—è—Ü–∞–º');
         const completedBlock = renderBarList(completed, '–ó–∞–≤–µ—Ä—à–µ–Ω–æ –ø–æ –º–µ—Å—è—Ü–∞–º');
         return `
           <div class="grid gap-4 md:grid-cols-2">
             ${createdBlock}
             ${completedBlock}
           </div>
         `;
       }

        function renderEmployeesTagsDashboard(items) {
          const employees = Array.isArray(filterSettings?.employees) ? filterSettings.employees.filter(Boolean) : [];
          if (!employees.length) {
            return '<div class="rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-600 dark:border-gray-800 dark:bg-gray-950 dark:text-gray-400">–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–º–∏–ª–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ñ–∏–ª—å—Ç—Ä–∞ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ ¬´–¢–µ–≥–∏¬ª —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞.</div>';
          }
          const groups = computeEmployeeCountsByTags(items);
          const totalTasks = items.length;
          const employeesCount = employees.length;
          const norm = employeesCount > 0 ? totalTasks / employeesCount : 0;
          const rowsHtml = groups.map((g) => {
            const fact = g.count;
            const deviation = fact - norm;
            const deviationPct = norm > 0 ? (deviation / norm) * 100 : 0;
            const status = deviation > norm * 0.1
              ? '–≤—ã—à–µ –Ω–æ—Ä–º—ã'
              : (deviation < -norm * 0.1 ? '–Ω–∏–∂–µ –Ω–æ—Ä–º—ã' : '–≤ –Ω–æ—Ä–º–µ');
            const statusColor = status === '–≤—ã—à–µ –Ω–æ—Ä–º—ã' ? 'text-emerald-600 dark:text-emerald-400' : (status === '–Ω–∏–∂–µ –Ω–æ—Ä–º—ã' ? 'text-rose-600 dark:text-rose-400' : 'text-gray-700 dark:text-gray-300');
            const widthPct = groups.length ? Math.round((fact / Math.max(1, ...groups.map(x => x.count))) * 100) : 0;
            return `
              <div class="grid grid-cols-[1fr_auto_auto_auto_auto] items-center gap-3">
                <div class="min-w-0">
                  <div class="truncate text-sm">${escapeHtml(g.label)}</div>
                  <div class="mt-1 h-2 w-full overflow-hidden rounded bg-gray-100 dark:bg-gray-800">
                    <div class="h-2 rounded bg-gray-900 dark:bg-white" style="width: ${widthPct}%"></div>
                  </div>
                </div>
                <div class="text-right text-sm tabular-nums">${fact}</div>
                <div class="text-right text-sm tabular-nums text-gray-600 dark:text-gray-400">${norm.toFixed(2)}</div>
                <div class="text-right text-sm tabular-nums ${deviation >= 0 ? 'text-emerald-700 dark:text-emerald-400' : 'text-rose-700 dark:text-rose-400'}">${deviation >= 0 ? '+' : ''}${deviation.toFixed(2)}</div>
                <div class="text-right text-sm tabular-nums ${statusColor}">${deviationPct >= 0 ? '+' : ''}${deviationPct.toFixed(1)}% ¬∑ ${status}</div>
              </div>
            `;
          }).join('');
          const header = `
            <div class="mb-3 text-sm font-medium text-gray-700 dark:text-gray-300">
              –ù–æ—Ä–º–∞—Ç–∏–≤: ${totalTasks} / ${employeesCount} = <span class="tabular-nums">${norm.toFixed(2)}</span> –∑–∞–¥–∞—á –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            </div>
          `;
          const legend = `
            <div class="mb-2 text-xs text-gray-500 dark:text-gray-400">–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = —Ñ–∞–∫—Ç ‚àí –Ω–æ—Ä–º–∞—Ç–∏–≤. –°—Ç–∞—Ç—É—Å: –≤—ã—à–µ –Ω–æ—Ä–º—ã / –≤ –Ω–æ—Ä–º–µ / –Ω–∏–∂–µ –Ω–æ—Ä–º—ã (¬±10%). –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã.</div>
          `;
          const body = rowsHtml || '<div class="text-sm text-gray-500 dark:text-gray-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
          return `
            <div class="rounded-xl border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-gray-950">
              ${header}
              ${legend}
              <div class="grid grid-cols-[1fr_auto_auto_auto_auto] gap-3 px-0 pb-2 text-xs font-medium text-gray-500 dark:text-gray-400">
                <div>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
                <div class="text-right">–§–∞–∫—Ç</div>
                <div class="text-right">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
                <div class="text-right">–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</div>
                <div class="text-right">% –∏ —Å—Ç–∞—Ç—É—Å</div>
              </div>
              <div class="space-y-3">${body}</div>
            </div>
          `;
        }

       function renderDashboardContent() {
         if (!dashboardsPanel || !dashboardContent) return;
         const hasAny = Array.isArray(allTasks) && allTasks.length > 0;
         if (!hasAny) {
           dashboardContent.innerHTML = '';
           return;
         }
         if (currentDashboard === 'table') {
           dashboardContent.innerHTML = '';
           return;
         }
         const items = Array.isArray(lastFilteredTasks) && lastFilteredTasks.length ? lastFilteredTasks : allTasks;
         let html = '';
         if (currentDashboard === 'companies') {
           const data = computeGroupedCounts(items, 'company');
           html = renderBarList(data, '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º');
         } else if (currentDashboard === 'assignees') {
           const data = computeGroupedCounts(items, 'assignee');
           html = renderBarList(data, '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º');
         } else if (currentDashboard === 'timeline') {
           html = renderTimelineDashboard(items);
          } else if (currentDashboard === 'employees-tags') {
            html = renderEmployeesTagsDashboard(items);
          } else if (currentDashboard === 'data-quality') {
            html = renderDataQualityDashboard(items);
          } else if (currentDashboard === 'tags') {
            html = renderTagsFrequencyDashboard(items);
          } else if (currentDashboard === 'company-duration') {
            html = renderCompanyDurationDashboard(items);
          } else if (currentDashboard === 'assignee-duration') {
            html = renderAssigneeDurationDashboard(items);
         } else {
           html = '<div class="text-sm text-gray-600 dark:text-gray-400">–î–∞—à–±–æ—Ä–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>';
         }
         const hint = `<div class=\"mb-2 text-xs text-gray-500 dark:text-gray-400\">–£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã.</div>`;
         dashboardContent.innerHTML = hint + html;
       }

      // Toast-style notifications
      (function ensureToastRoot(){
        if (!document.getElementById('toastRoot')) {
          const el = document.createElement('div');
          el.id = 'toastRoot';
          el.className = 'pointer-events-none fixed inset-0 z-50 flex flex-col items-end gap-2 p-4';
          document.body.appendChild(el);
        }
      })();

      function showMessage(text, type = 'info') {
        const root = document.getElementById('toastRoot');
        if (!root) return;
        const toast = document.createElement('div');
        const base = 'pointer-events-auto rounded-md border px-3 py-2 text-sm shadow-sm animate-[fadein_.2s_ease]';
        toast.className = base + ' ' + (type === 'error'
          ? 'border-red-300 bg-red-50 text-red-900 dark:border-red-800 dark:bg-red-950/40 dark:text-red-200'
          : type === 'warn'
            ? 'border-amber-300 bg-amber-50 text-amber-900 dark:border-amber-700 dark:bg-amber-950/40 dark:text-amber-200'
            : 'border-gray-200 bg-white text-gray-800 dark:border-gray-800 dark:bg-gray-950 dark:text-gray-200');
        toast.textContent = text;
        root.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity .2s ease';
          setTimeout(() => toast.remove(), 200);
        }, 2500);
      }

      function hideMessage() {
        message.classList.add('hidden');
      }

      // Password visibility toggles
      function setupPasswordToggles() {
        document.querySelectorAll('[data-toggle-password]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-toggle-password');
            const input = document.getElementById(id);
            if (!input) return;
            const isPassword = input.getAttribute('type') === 'password';
            input.setAttribute('type', isPassword ? 'text' : 'password');
            const span = btn.querySelector('span');
            if (span) span.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
          });
        });
      }

      function normalizeHeader(text) {
        return (text || '')
          .toLowerCase()
          .replace(/[\s\t\n\r]+/g, ' ')
          .replace(/[.,;:!?()\[\]{}<>"'`]+/g, '')
          .trim();
      }

      function extractTable(htmlString) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const table = doc.querySelector('table');
        if (!table) throw new Error('–í HTML –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ <table>.');

        // Collect header cells
        let headerRow = table.querySelector('thead tr');
        if (!headerRow) {
          headerRow = table.querySelector('tr');
        }
        if (!headerRow) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ <tr> –≤ —Ç–∞–±–ª–∏—Ü–µ.');

        const headerCells = Array.from(headerRow.querySelectorAll('th, td'));
        const headersRaw = headerCells.map((c) => c.textContent.trim());
        const headersNorm = headersRaw.map(normalizeHeader);

        // Collect body rows
        let bodyRows = [];
        const tbodies = table.querySelectorAll('tbody');
        if (tbodies.length) {
          tbodies.forEach((tb) => {
            bodyRows.push(...Array.from(tb.querySelectorAll('tr')));
          });
        } else {
          bodyRows = Array.from(table.querySelectorAll('tr'));
        }
        // Remove headerRow if present in bodyRows
        bodyRows = bodyRows.filter((r) => r !== headerRow && r.querySelectorAll('td, th').length > 0);

        const rows = bodyRows.map((row) => {
          const cells = Array.from(row.querySelectorAll('td, th'));
          return cells.map((c) => c.textContent.replace(/\s+/g, ' ').trim());
        });

        return { headersRaw, headersNorm, rows };
      }

      function suggestMapping(headersNorm) {
        const candidates = {
          id: [
            'id', '–∏–¥', '–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä', '–Ω–æ–º–µ—Ä', 'task id', 'issue id', 'ticket id', 'reference', 'ref', '–∫–æ–¥'
          ],
          title: [
            '–Ω–∞–∑–≤–∞–Ω–∏–µ', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–∑–∞–≥–æ–ª–æ–≤–æ–∫', '—Ç–µ–º–∞', '–æ–ø–∏—Å–∞–Ω–∏–µ', 'title', 'summary', 'subject', 'name'
          ],
          company: [
            '–∫–æ–º–ø–∞–Ω–∏—è', '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', 'company', 'customer', 'client', '–∫–ª–∏–µ–Ω—Ç', '–∑–∞–∫–∞–∑—á–∏–∫', 'vendor', 'partner', '—Ñ–∏—Ä–º–∞'
          ],
          assignee: [
            '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', 'assignee', 'owner', 'assigned to', 'executor', 'author', '–≤—ã–ø–æ–ª–Ω—è—é—â–∏–π'
          ],
          duration: [
            '–∑–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è', '–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–≤—Ä–µ–º—è', 'hours', 'spent', 'time spent', 'duration', 'worklog', 'spend', '–∑–∞—Ç—Ä–∞—á–µ–Ω–æ'
          ],
          created: [
            '–¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', '—Å–æ–∑–¥–∞–Ω–æ', '—Å–æ–∑–¥–∞–Ω', 'created', 'created at', 'creation date', 'created on', 'start date', 'open date', 'opened', 'created time'
          ],
          completed: [
            '–¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', '–∑–∞–≤–µ—Ä—à–µ–Ω–æ', '–∑–∞–∫—Ä—ã—Ç–æ', '–∑–∞–∫—Ä—ã—Ç', 'completed', 'done', 'closed', 'resolved', 'resolution date', 'completed at', 'finish date'
          ]
        };

        function findIndex(synonyms) {
          // Exact match first
          for (let i = 0; i < headersNorm.length; i++) {
            if (synonyms.includes(headersNorm[i])) return i;
          }
          // Contains match
          for (let i = 0; i < headersNorm.length; i++) {
            const h = headersNorm[i];
            if (synonyms.some((s) => h.includes(s))) return i;
          }
          return -1;
        }

        return {
          id: findIndex(candidates.id),
          title: findIndex(candidates.title),
          company: findIndex(candidates.company),
          assignee: findIndex(candidates.assignee),
          created: findIndex(candidates.created),
          completed: findIndex(candidates.completed),
          duration: findIndex(candidates.duration),
          tags: findIndex(['—Ç–µ–≥–∏', 'tags', '—è—Ä–ª—ã–∫–∏', 'labels', '–º–µ—Ç–∫–∏'])
        };
      }

       function buildTasks(rows, map) {
        const validIdx = [map.id, map.title, map.created, map.completed].every((i) => i >= 0);
        if (!validIdx) return [];
        const tasks = [];
        for (const r of rows) {
          const id = r[map.id] ?? '';
          const title = r[map.title] ?? '';
          const company = map.company >= 0 ? (r[map.company] ?? '') : '';
          const assignee = map.assignee >= 0 ? (r[map.assignee] ?? '') : '';
          const created = r[map.created] ?? '';
          const completed = r[map.completed] ?? '';
          const duration = map.duration >= 0 ? (r[map.duration] ?? '') : '';
          const tags = map.tags >= 0 ? (r[map.tags] ?? '') : '';
          if (!id && !title && !created && !completed && !company) continue;
          tasks.push({ id, title, company, assignee, created, completed, duration, tags, rawCells: r });
        }
        return tasks;
      }

      function renderTasks(tasks) {
        // Ensure header reflects current columns
        renderTableHeader();
        resultsBody.innerHTML = '';
        const frag = document.createDocumentFragment();
        for (const t of tasks) {
          const tr = document.createElement('tr');
          tr.className = 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-900/60';
          const rowValues = visibleColumns.map((key) => {
            if (String(key).startsWith('rawidx:')) {
              const idx = Number(String(key).slice('rawidx:'.length));
              return Array.isArray(t.rawCells) ? (t.rawCells[idx] ?? '') : '';
            }
            if (key === 'duration') return String(t.duration || '').trim();
            return t[key];
          });
          visibleColumns.forEach((key, i) => {
            const val = rowValues[i];
            const td = document.createElement('td');
            td.className = 'px-3 py-2 align-top truncate';
            const w = Number(columnWidths?.[key]);
            if (Number.isFinite(w) && w > 24) {
              td.style.width = w + 'px';
              td.style.minWidth = w + 'px';
              td.style.maxWidth = w + 'px';
            }
            const v = val ?? '';
            if (String(v).trim() === '') {
              td.innerHTML = '<span class="text-gray-400 dark:text-gray-500">–Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</span>';
            } else {
              td.textContent = v;
            }
            tr.appendChild(td);
          });
          tr.addEventListener('click', () => openTaskDetails(t));
          frag.appendChild(tr);
        }
        resultsBody.appendChild(frag);
        // visibility and stats handled by setTasks/applyFilters
      }

      function setTasks(tasks) {
        allTasks = Array.isArray(tasks) ? tasks : [];
        const hasAny = allTasks.length > 0;
         resultsCard.classList.toggle('hidden', !hasAny);
         // Toggle upload and dashboards visibility (auth gate may override)
         if (dashboardsPanel) dashboardsPanel.classList.toggle('hidden', !hasAny);
         if (uploadCard) uploadCard.classList.toggle('hidden', hasAny);
        if (!hasAny) {
          stats.textContent = '';
          resultsBody.innerHTML = '';
          return;
        }
         applyFilters();
         // Ensure dashboard state is applied
         setActiveDashboard(currentDashboard);
         // Enforce auth gate
         applyAuthGate();
      }

      function debounce(fn, ms) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      function parseDateFromCell(value) {
        if (!value) return NaN;
        const trimmed = String(value).trim();
        if (!trimmed) return NaN;
        // Try native Date first
        const native = new Date(trimmed);
        if (!Number.isNaN(native.getTime()) && native.getFullYear() > 1900 && native.getFullYear() < 2100) {
          return native.getTime();
        }
        // Try common DD.MM.YYYY[ HH:mm[:ss]]
        const m = trimmed.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
        if (m) {
          let [_, dd, mm, yyyy, HH = '0', MM = '0', SS = '0'] = m;
          const day = parseInt(dd, 10);
          const month = parseInt(mm, 10) - 1;
          let year = parseInt(yyyy, 10);
          if (yyyy.length === 2) year += 2000;
          const hours = parseInt(HH, 10);
          const minutes = parseInt(MM, 10);
          const seconds = parseInt(SS, 10);
          const d = new Date(year, month, day, hours, minutes, seconds);
          if (!Number.isNaN(d.getTime())) return d.getTime();
        }
        return NaN;
      }

      function parseISODateInput(value, isEndOfDay = false) {
        if (!value) return NaN;
        const t = isEndOfDay ? 'T23:59:59.999' : 'T00:00:00.000';
        const d = new Date(value + t);
        return d.getTime();
      }

      // Helpers for duration stats (lead time between created and completed)
      function toDays(ms) {
        return ms / (24 * 60 * 60 * 1000);
      }

      function getCompletedTasks(items) {
        return (items || []).filter((t) => {
          const c1 = parseDateFromCell(t.created);
          const c2 = parseDateFromCell(t.completed);
          return !Number.isNaN(c1) && !Number.isNaN(c2) && c2 >= c1;
        });
      }

      function computeNumberStats(values) {
        const arr = (values || []).filter((v) => Number.isFinite(v)).sort((a, b) => a - b);
        const n = arr.length;
        if (!n) return { count: 0, avg: NaN, median: NaN, p90: NaN };
        const sum = arr.reduce((s, x) => s + x, 0);
        const avg = sum / n;
        const median = n % 2 ? arr[(n - 1) / 2] : (arr[n / 2 - 1] + arr[n / 2]) / 2;
        const p90Idx = Math.max(0, Math.min(n - 1, Math.ceil(0.9 * n) - 1));
        const p90 = arr[p90Idx];
        return { count: n, avg, median, p90 };
      }

      function groupDurationsBy(items, fieldKey) {
        const groups = new Map();
        for (const t of getCompletedTasks(items)) {
          const d1 = parseDateFromCell(t.created);
          const d2 = parseDateFromCell(t.completed);
          const days = toDays(d2 - d1);
          const raw = (t?.[fieldKey] ?? '').toString().trim();
          const label = raw || '‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî';
          if (!groups.has(label)) groups.set(label, []);
          groups.get(label).push(days);
        }
        const result = [];
        for (const [label, arr] of groups.entries()) {
          const s = computeNumberStats(arr);
          result.push({ label, count: s.count, avg: s.avg, median: s.median, p90: s.p90 });
        }
        return result;
      }

      function renderStatsGrid(rows, columns, caption) {
        const header = `
          <div class="mb-3 text-sm font-medium text-gray-700 dark:text-gray-300">${caption ? escapeHtml(caption) : ''}</div>
          <div class="grid grid-cols-${columns.length} gap-3 px-0 pb-2 text-xs font-medium text-gray-500 dark:text-gray-400">
            ${columns.map((c) => `<div class=\"${c.align === 'right' ? 'text-right' : ''}\">${escapeHtml(c.title)}</div>`).join('')}
          </div>
        `;
        const body = rows.map((r) => {
          return `
            <div class="grid grid-cols-${columns.length} items-center gap-3">
              ${columns.map((c) => `<div class=\"${c.align === 'right' ? 'text-right tabular-nums' : 'min-w-0 truncate'}\">${c.format ? c.format(r[c.key]) : escapeHtml(String(r[c.key] ?? ''))}</div>`).join('')}
            </div>
          `;
        }).join('');
        return `
          <div class="rounded-xl border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-gray-950">
            ${header}
            <div class="space-y-3">${body || '<div class="text-sm text-gray-500 dark:text-gray-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}</div>
          </div>
        `;
      }

      function renderCompanyDurationDashboard(items) {
        const TOP_N = 10;
        const groups = groupDurationsBy(items, 'company')
          .sort((a, b) => b.count - a.count || b.avg - a.avg)
          .slice(0, TOP_N);
        const columns = [
          { key: 'label', title: '–ö–æ–º–ø–∞–Ω–∏—è' },
          { key: 'count', title: '–ö–æ–ª-–≤–æ', align: 'right', format: (v) => String(v) },
          { key: 'avg', title: '–°—Ä–µ–¥–Ω., –¥–Ω–∏', align: 'right', format: (v) => Number.isFinite(v) ? v.toFixed(2) : '‚Äî' }
        ];
        return renderStatsGrid(groups, columns, `–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º (Top ${TOP_N})`);
      }

      function renderAssigneeDurationDashboard(items) {
        const groups = groupDurationsBy(items, 'assignee')
          .sort((a, b) => b.count - a.count || b.avg - a.avg);
        const columns = [
          { key: 'label', title: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' },
          { key: 'count', title: '–ö–æ–ª-–≤–æ', align: 'right', format: (v) => String(v) },
          { key: 'avg', title: '–°—Ä–µ–¥–Ω., –¥–Ω–∏', align: 'right', format: (v) => Number.isFinite(v) ? v.toFixed(2) : '‚Äî' },
          { key: 'median', title: '–ú–µ–¥–∏–∞–Ω–∞, –¥–Ω–∏', align: 'right', format: (v) => Number.isFinite(v) ? v.toFixed(2) : '‚Äî' },
          { key: 'p90', title: 'P90, –¥–Ω–∏', align: 'right', format: (v) => Number.isFinite(v) ? v.toFixed(2) : '‚Äî' }
        ];
        return renderStatsGrid(groups, columns, '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º');
      }

      function computeTagFrequency(items) {
        const map = new Map();
        for (const t of items) {
          const raw = String(t?.tags || '');
          if (!raw.trim()) continue;
          const tokens = raw
            .split(/[;,\|\/#\n\r\t]+|\s{2,}/g)
            .map((s) => s.trim())
            .filter(Boolean)
            .map((s) => s.toLowerCase());
          for (const tok of tokens) {
            map.set(tok, (map.get(tok) || 0) + 1);
          }
        }
        const arr = Array.from(map.entries()).map(([label, count]) => ({ label, count }));
        arr.sort((a, b) => b.count - a.count || a.label.localeCompare(b.label, 'ru'));
        return arr;
      }

      function renderTagsFrequencyDashboard(items) {
        const TOP_N = 30;
        const data = computeTagFrequency(items).slice(0, TOP_N);
        return renderBarList(data, `–¢–æ–ø ${TOP_N} —Ç–µ–≥–æ–≤`);
      }

      function renderDataQualityDashboard(items) {
        const total = items.length;
        const counts = {
          noCompany: 0,
          noAssignee: 0,
          noTags: 0,
          badCreated: 0,
          badCompleted: 0,
          duplicateIdTasks: 0
        };
        const idCounts = new Map();
        for (const t of items) {
          const company = String(t.company || '').trim();
          const assignee = String(t.assignee || '').trim();
          const tags = String(t.tags || '').trim();
          const createdTs = parseDateFromCell(t.created);
          const completedRaw = String(t.completed || '').trim();
          const completedTs = parseDateFromCell(t.completed);
          const id = String(t.id || '').trim();
          if (!company) counts.noCompany++;
          if (!assignee) counts.noAssignee++;
          if (!tags) counts.noTags++;
          if (Number.isNaN(createdTs)) counts.badCreated++;
          if (completedRaw && Number.isNaN(completedTs)) counts.badCompleted++;
          if (id) idCounts.set(id, (idCounts.get(id) || 0) + 1);
        }
        for (const [, c] of idCounts.entries()) {
          if (c > 1) counts.duplicateIdTasks += (c - 1);
        }
        const groups = [
          { label: `–í—Å–µ–≥–æ –∑–∞–¥–∞—á`, count: total },
          { label: `–ü—É—Å—Ç–∞—è –∫–æ–º–ø–∞–Ω–∏—è`, count: counts.noCompany },
          { label: `–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π`, count: counts.noAssignee },
          { label: `–ü—É—Å—Ç—ã–µ —Ç–µ–≥–∏`, count: counts.noTags },
          { label: `–ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è`, count: counts.badCreated },
          { label: `–ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è`, count: counts.badCompleted },
          { label: `–ó–∞–¥–∞—á–∏ —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º—Å—è ID`, count: counts.duplicateIdTasks }
        ];
        return renderBarList(groups, '–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö');
      }

      function formatDuration(ms) {
        if (!Number.isFinite(ms) || ms < 0) return '';
        const totalSeconds = Math.floor(ms / 1000);
        const days = Math.floor(totalSeconds / (24 * 3600));
        const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const parts = [];
        if (days) parts.push(days + ' –¥');
        if (hours) parts.push(hours + ' —á');
        if (minutes) parts.push(minutes + ' –º');
        return parts.join(' ');
      }

      function isEmptyValue(v) {
        return !String(v ?? '').trim();
      }

      function isLongText(v) {
        const s = String(v || '');
        return s.length > 200 || s.includes('\n');
      }

      function truncateText(v, maxLen = 200) {
        const s = String(v || '');
        if (s.length <= maxLen) return s;
        return s.slice(0, maxLen) + '‚Ä¶';
      }

      function renderValueWithToggle(value) {
        const raw = String(value || '');
        if (!isLongText(raw)) {
          return `<div class="whitespace-pre-wrap break-words">${escapeHtml(raw)}</div>`;
        }
        const short = truncateText(raw, 200);
        return `
          <div class="long-text-block">
            <div class="long-text short whitespace-pre-wrap break-words">${escapeHtml(short)}</div>
            <div class="long-text full hidden whitespace-pre-wrap break-words">${escapeHtml(raw)}</div>
            <button type="button" class="toggleLongText mt-1 text-xs text-gray-600 underline">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
          </div>
        `;
      }

      function openTaskDetails(task) {
        if (!task) return;
        // Title
        const idText = String(task.id || '').trim();
        const titleText = String(task.title || '').trim();
        detailsTitle.textContent = idText ? `${idText}${titleText ? ' ‚Äî ' + titleText : ''}` : (titleText || '–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏');

        // Status and durations
        const createdTs = parseDateFromCell(task.created);
        const completedTs = parseDateFromCell(task.completed);
        const nowTs = Date.now();
        const isCompleted = !Number.isNaN(completedTs);
        const statusText = isCompleted ? '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' : '–û—Ç–∫—Ä—ã—Ç–∞';
        const durationMs = !Number.isNaN(createdTs)
          ? (isCompleted ? (completedTs - createdTs) : (nowTs - createdTs))
          : NaN;
        const durationText = formatDuration(durationMs);

        // Overview block
         const overviewRows = [
          { k: 'ID', v: task.id || '' },
          { k: '–ù–∞–∑–≤–∞–Ω–∏–µ', v: task.title || '' },
          { k: '–ö–æ–º–ø–∞–Ω–∏—è', v: task.company || '' },
           { k: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', v: task.assignee || '' },
          { k: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', v: task.created || '' },
          { k: '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', v: task.completed || '' },
           { k: '–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è', v: task.duration || '' },
          { k: '–°—Ç–∞—Ç—É—Å', v: statusText + (durationText ? ` (${durationText})` : '') }
        ].filter((row) => !isEmptyValue(row.v));

        // Full row mapping: header -> value
         const headers = Array.isArray(lastParsedHeaders) ? lastParsedHeaders : [];
        const cells = Array.isArray(task.rawCells) ? task.rawCells : [];
        const maxLen = Math.max(headers.length, cells.length);
        let allFieldsHtml = '';
        for (let i = 0; i < maxLen; i++) {
          const label = headers[i] != null && String(headers[i]).trim() !== '' ? headers[i] : `–ö–æ–ª–æ–Ω–∫–∞ ${i + 1}`;
          const value = cells[i] != null ? cells[i] : '';
          if (isEmptyValue(value)) continue;
          allFieldsHtml += `
            <div class="contents">
              <div class="truncate px-3 py-2 font-medium">${escapeHtml(label)}</div>
              <div class="px-3 py-2">${renderValueWithToggle(value)}</div>
            </div>
          `;
        }

        detailsContent.innerHTML = `
          <div class="space-y-6">
            <div>
              <h4 class="mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">–û—Å–Ω–æ–≤–Ω–æ–µ</h4>
              <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">
                ${overviewRows
                  .map((row) => `
                    <div class="rounded-lg border border-gray-200 bg-white p-3 text-sm dark:border-gray-800 dark:bg-gray-900">
                      <div class="text-gray-500 dark:text-gray-400">${escapeHtml(row.k)}</div>
                      <div class="mt-0.5 font-medium">${renderValueWithToggle(row.v)}</div>
                    </div>
                  `)
                  .join('')}
              </div>
            </div>
            <div>
              <h4 class="mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">–í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ —Å—Ç—Ä–æ–∫–∏</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2">
                ${allFieldsHtml || '<div class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">–ù–µ—Ç –Ω–µ–ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</div>'}
              </div>
            </div>
          </div>
        `;

        // Show modal
        detailsModal.classList.remove('hidden');
      }

      function closeTaskDetails() {
        detailsModal.classList.add('hidden');
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      function applyFilters() {
        if (!allTasks.length) {
          resultsBody.innerHTML = '';
          stats.textContent = '';
          return;
        }
        // New include/exclude search over Title and Tags
        const includeInput = document.getElementById('filterQuery');
        const excludeInput = document.getElementById('filterExclude');
        const includeAllCheckbox = null;
        const includeRaw = (includeInput?.value || '').trim();
        const excludeRaw = (excludeInput?.value || '').trim();
        const includeAll = (filterSettings?.tagsMode === 'all');
        const normalize = (s) => String(s || '').toLowerCase().replace(/—ë/g, '–µ');
        const splitTerms = (s) => normalize(s).split(/[;,\n]+/g).map(t => t.trim()).filter(Boolean);
        const readChips = (hostId) => Array.from(document.getElementById(hostId)?.querySelectorAll('span[data-term]') || []).map(el => normalize(el.dataset.term || ''));
        const includeChipTerms = readChips('includeChips');
        const excludeChipTerms = readChips('excludeChips');
        // primary source is chips
        const buildMatchers = (terms) => terms.map(term => {
          const isQuoted = term.startsWith('"') && term.endsWith('"') && term.length >= 2;
          const isPrefix = term.endsWith('*') && !isQuoted;
          const raw = isQuoted ? term.slice(1, -1) : (isPrefix ? term.slice(0, -1) : term);
          if (isQuoted) return (text) => text.includes(raw);
          if (isPrefix) {
            const re = new RegExp(`(?:^|[^A-Za-z–ê-–Ø–∞-—è–Å—ë0-9])${raw}[A-Za-z–ê-–Ø–∞-—è–Å—ë0-9]*`, 'i');
            return (text) => re.test(text);
          }
          const re = new RegExp(`(?:^|[^A-Za-z–ê-–Ø–∞-—è–Å—ë0-9])${raw}(?:[^A-Za-z–ê-–Ø–∞-—è–Å—ë0-9]|$)`, 'i');
          return (text) => re.test(text);
        });
        const includeTerms = buildMatchers([
          ...includeChipTerms,
          ...splitTerms(includeRaw)
        ]);
        const excludeTerms = buildMatchers([
          ...excludeChipTerms,
          ...splitTerms(excludeRaw)
        ]);

        const createdFrom = parseISODateInput(createdFromInput?.value || '');
        const createdTo = parseISODateInput(createdToInput?.value || '', true);
        const completedFrom = parseISODateInput(completedFromInput?.value || '');
        const completedTo = parseISODateInput(completedToInput?.value || '', true);

        const filtered = allTasks.filter((t) => {
          const text = `${normalize(t.title)} ${normalize(t.tags)}`;
          if (excludeTerms.length && excludeTerms.some(fn => fn(text))) return false;
          if (includeTerms.length) {
            if (includeAll && !includeTerms.every(fn => fn(text))) return false;
            if (!includeAll && !includeTerms.some(fn => fn(text))) return false;
          }
          // Created date range
          if (createdFrom || createdTo) {
            const ts = parseDateFromCell(t.created);
            if (Number.isNaN(ts)) return false;
            if (createdFrom && ts < createdFrom) return false;
            if (createdTo && ts > createdTo) return false;
          }
          // Completed date range
          if (completedFrom || completedTo) {
            const ts = parseDateFromCell(t.completed);
            if (Number.isNaN(ts)) return false;
            if (completedFrom && ts < completedFrom) return false;
            if (completedTo && ts > completedTo) return false;
          }
          return true;
        });

        renderTasks(filtered);
        stats.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${filtered.length} –∏–∑ ${allTasks.length}`;
        lastFilteredTasks = filtered;
        if (currentDashboard !== 'table') {
          renderDashboardContent();
        }
      }

      // Bookmarks: storage helpers
       const BM_STORAGE_KEY = 'task_table_filter_bookmarks_v1';
       async function loadBookmarksShared() {
         try {
           const res = await fetch('/api/bookmarks/shared', { credentials: 'same-origin' });
           if (res.ok) {
             const data = await res.json();
             bookmarks = Array.isArray(data?.bookmarks) ? data.bookmarks : [];
           } else {
             bookmarks = [];
           }
         } catch (_) { bookmarks = []; }
         renderBookmarksSelect();
       }

       async function loadBookmarksPersonal() {
         try {
           const res = await fetch('/api/bookmarks/personal', { credentials: 'same-origin' });
           if (res.ok) {
             const data = await res.json();
             personalBookmarks = Array.isArray(data?.bookmarks) ? data.bookmarks : [];
           } else {
             personalBookmarks = [];
           }
         } catch (_) { personalBookmarks = []; }
         renderBookmarksSelect();
       }

       async function loadBookmarksBoth() {
         await Promise.all([loadBookmarksShared(), loadBookmarksPersonal()].map(p => p.catch(() => {})));
         renderBookmarksSelect();
       }

       async function saveBookmarkToServerShared(bm) {
         const res = await fetch('/api/bookmarks/shared', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           credentials: 'same-origin',
           body: JSON.stringify({ name: bm.name, config: bm })
         });
         if (res.ok) {
           try { const data = await res.json(); return data?.id ?? null; } catch (_) { return null; }
         }
         return null;
       }

       async function saveBookmarkToServerPersonal(bm) {
         const res = await fetch('/api/bookmarks/personal', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           credentials: 'same-origin',
           body: JSON.stringify({ name: bm.name, config: bm })
         });
         if (res.ok) {
           try { const data = await res.json(); return data?.id ?? null; } catch (_) { return null; }
         }
         return null;
       }

       async function updateBookmarkOnServerShared(id, payload) {
         await fetch(`/api/bookmarks/shared/${id}`, {
           method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(payload)
         });
       }

       async function updateBookmarkOnServerPersonal(id, payload) {
         await fetch(`/api/bookmarks/personal/${id}`, {
           method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(payload)
         });
       }

       async function deleteBookmarkOnServerShared(id) {
         await fetch(`/api/bookmarks/shared/${id}`, { method: 'DELETE', credentials: 'same-origin' });
       }

       async function deleteBookmarkOnServerPersonal(id) {
         await fetch(`/api/bookmarks/personal/${id}`, { method: 'DELETE', credentials: 'same-origin' });
       }

       // Last source (file/html) storage helpers
       const LAST_SOURCE_KEY = 'task_table_last_source_v1';
       function saveLastSource(payload) {
         try {
           localStorage.setItem(LAST_SOURCE_KEY, JSON.stringify(payload));
         } catch (_) {}
       }

       function loadLastSource() {
         try {
           const raw = localStorage.getItem(LAST_SOURCE_KEY);
           if (!raw) return null;
           const obj = JSON.parse(raw);
           if (obj && typeof obj === 'object' && typeof obj.text === 'string') return obj;
           return null;
         } catch (_) {
           return null;
         }
       }

      function getCurrentFilterConfig() {
        const readChips = (hostId) => Array.from(document.getElementById(hostId)?.querySelectorAll('span[data-term]')||[]).map(n=>n.dataset.term);
        return {
          name: (bmNameInput?.value || '').trim(),
          query: filterQuery?.value || '',
          createdFrom: createdFromInput?.value || '',
          createdTo: createdToInput?.value || '',
          completedFrom: completedFromInput?.value || '',
          completedTo: completedToInput?.value || '',
          createdRange: createdRangeInput?.value || '',
          completedRange: completedRangeInput?.value || '',
          // bookmark stores chip-based filters
          include: readChips('includeChips'),
          exclude: readChips('excludeChips'),
          // keep these for future but chips are primary
          tagsKeywords: Array.isArray(filterSettings?.tagsKeywords) ? filterSettings.tagsKeywords : [],
          tagsMode: filterSettings?.tagsMode || 'any',
          employees: Array.isArray(filterSettings?.employees) ? filterSettings.employees : []
        };
      }

      function applyFilterConfig(cfg) {
        if (!cfg) return;
        if (filterQuery) filterQuery.value = cfg.query || '';
        if (createdFromInput) createdFromInput.value = cfg.createdFrom || '';
        if (createdToInput) createdToInput.value = cfg.createdTo || '';
        if (completedFromInput) completedFromInput.value = cfg.completedFrom || '';
        if (completedToInput) completedToInput.value = cfg.completedTo || '';
        if (createdRangeInput) createdRangeInput.value = cfg.createdRange || formatDisplayRange(cfg.createdFrom, cfg.createdTo);
        if (completedRangeInput) completedRangeInput.value = cfg.completedRange || formatDisplayRange(cfg.completedFrom, cfg.completedTo);
        // apply include/exclude chips from bookmark
        const incHost = document.getElementById('includeChips');
        const excHost = document.getElementById('excludeChips');
        if (incHost) {
          incHost.replaceChildren();
          (Array.isArray(cfg.include) ? cfg.include : []).forEach((t) => {
            const s = document.createElement('span');
            s.className = 'inline-flex items-center gap-1 rounded-full border border-green-300 bg-green-50 px-2 py-0.5 text-xs text-green-700 dark:border-green-600 dark:bg-green-900/20 dark:text-green-300';
            s.dataset.term = t;
            s.textContent = t;
            incHost.appendChild(s);
          });
        }
        if (excHost) {
          excHost.replaceChildren();
          (Array.isArray(cfg.exclude) ? cfg.exclude : []).forEach((t) => {
            const s = document.createElement('span');
            s.className = 'inline-flex items-center gap-1 rounded-full border border-red-300 bg-red-50 px-2 py-0.5 text-xs text-red-700 dark:border-red-600 dark:bg-red-900/20 dark:text-red-300';
            s.dataset.term = t;
            s.textContent = t;
            excHost.appendChild(s);
          });
        }
        // tags settings
        filterSettings.tagsKeywords = Array.isArray(cfg.tagsKeywords)
          ? cfg.tagsKeywords
          : String(cfg.tagsKeywords || '')
              .split(/[;,\n\r]+/g)
              .map((s) => s.trim())
              .filter(Boolean);
        filterSettings.tagsMode = cfg.tagsMode === 'all' ? 'all' : 'any';
        if (tagsKeywordsInput) tagsKeywordsInput.value = filterSettings.tagsKeywords.join(', ');
        if (tagsModeSelect) tagsModeSelect.value = filterSettings.tagsMode;
        // employees
        filterSettings.employees = Array.isArray(cfg.employees)
          ? cfg.employees
          : String(cfg.employees || '')
              .split(/[;,\n\r]+/g)
              .map((s) => s.trim())
              .filter(Boolean);
        renderEmployeesChips();
        applyFilters();
      }

      function renderBookmarksSelect() {
        if (!bookmarksSelect) return;
        const current = bookmarksSelect.value;
        bookmarksSelect.innerHTML = '';
        const def = document.createElement('option');
        def.value = '';
        def.textContent = '‚Äî –Ω–µ—Ç –∑–∞–∫–ª–∞–¥–æ–∫ ‚Äî';
        bookmarksSelect.appendChild(def);
        bookmarks.forEach((b, idx) => {
          const opt = document.createElement('option');
          opt.value = String(idx);
          opt.textContent = b.name || `–ó–∞–∫–ª–∞–¥–∫–∞ ${idx + 1}`;
          bookmarksSelect.appendChild(opt);
        });
        if (current && Number(current) < bookmarks.length) {
          bookmarksSelect.value = current;
        }
        if (deleteBookmarkBtn) {
          deleteBookmarkBtn.disabled = !(bookmarksSelect.value && bookmarks.length);
        }
        // Also render chips
        const renderScope = async (list, hostId, addId, scope) => {
          const host = document.getElementById(hostId);
          const addBtn = document.getElementById(addId);
          if (!host || !addBtn) return;
          host.querySelectorAll('button[data-bm]').forEach((n) => n.remove());
          const activeIdx = (typeof window.__activeBmIdx === 'number') ? window.__activeBmIdx : -1;
          const activeId = (typeof window.__activeBmId !== 'undefined' && window.__activeBmId !== null)
            ? Number(window.__activeBmId)
            : null;
          list.forEach((b, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.dataset.bm = `${scope}:${idx}`;
            const base = 'inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-xs';
            const isActive = (activeId !== null && typeof b.id !== 'undefined')
              ? Number(b.id) === activeId
              : idx === activeIdx;
            btn.className = isActive
              ? `${base} border-transparent bg-gray-900 text-white dark:bg-white dark:text-gray-900`
              : `${base} border-gray-300 bg-white hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900`;
            const span = document.createElement('span');
            span.textContent = b.name || `–ó–∞–∫–ª–∞–¥–∫–∞ ${idx + 1}`;
            btn.appendChild(span);
            btn.addEventListener('click', () => {
              const isActiveNow = (
                (typeof b.id !== 'undefined' && window.__activeBmId !== null && Number(b.id) === Number(window.__activeBmId)) ||
                (window.__activeBmId == null && typeof window.__activeBmIdx === 'number' && window.__activeBmIdx === idx)
              );
              if (isActiveNow) {
                if (filterQuery) filterQuery.value = '';
                if (createdFromInput) createdFromInput.value = '';
                if (createdToInput) createdToInput.value = '';
                if (completedFromInput) completedFromInput.value = '';
                if (completedToInput) completedToInput.value = '';
                if (createdRangeInput) createdRangeInput.value = '';
                if (completedRangeInput) completedRangeInput.value = '';
                filterSettings.tagsKeywords = [];
                filterSettings.tagsMode = 'any';
                filterSettings.employees = [];
                if (tagsKeywordsInput) tagsKeywordsInput.value = '';
                if (tagsModeSelect) tagsModeSelect.value = 'any';
                renderEmployeesChips();
                const incHost = document.getElementById('includeChips');
                const excHost = document.getElementById('excludeChips');
                if (incHost) incHost.replaceChildren();
                if (excHost) excHost.replaceChildren();
                window.__activeBmId = null;
                window.__activeBmIdx = -1;
                renderBookmarksSelect();
                applyFilters();
              } else {
                const cfg = (b && b.config) ? b.config : b;
                applyFilterConfig(cfg);
                bmNameInput.value = b.name || '';
                if (typeof b.id !== 'undefined') window.__activeBmId = b.id;
                window.__activeBmIdx = idx;
                showMessage(`–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –∑–∞–∫–ª–∞–¥–∫–∞: ${b.name || `#${idx+1}`}`, 'info');
                renderBookmarksSelect();
              }
            });
            host.appendChild(btn);
          });
        };
        renderScope((personalBookmarks||[]), 'personalBookmarksChips', 'personalBookmarkAddBtn', 'personal');
        renderScope((bookmarks||[]), 'sharedBookmarksChips', 'sharedBookmarkAddBtn', 'shared');
      }

      // Chip-based add flow
      (function initBookmarkChips() {
        const personalHost = document.getElementById('personalBookmarksChips');
        const personalAddBtn = document.getElementById('personalBookmarkAddBtn');
        const sharedHost = document.getElementById('sharedBookmarksChips');
        const sharedAddBtn = document.getElementById('sharedBookmarkAddBtn');
        if (!personalHost || !personalAddBtn || !sharedHost || !sharedAddBtn) return;
        const personalEditBtn = document.getElementById('personalBookmarkEditBtn');
        const sharedEditBtn = document.getElementById('sharedBookmarkEditBtn');
        let personalEditMode = false;
        let sharedEditMode = false;
        
        if (personalEditBtn) {
          personalEditBtn.addEventListener('click', () => {
            personalEditMode = !personalEditMode;
            personalEditBtn.textContent = '‚úé';
            personalHost.classList.toggle('ring-1', personalEditMode);
            personalHost.classList.toggle('ring-amber-400', personalEditMode);
            // Add/remove delete buttons on chips
            personalHost.querySelectorAll('button[data-bm]').forEach((chip) => {
              const hasDel = chip.querySelector('button[data-delete]');
              if (personalEditMode && !hasDel) {
                const del = document.createElement('button');
                del.type = 'button';
                del.dataset.delete = 'true';
                del.className = 'text-gray-500 hover:text-rose-600 dark:text-gray-400 dark:hover:text-rose-400';
                del.textContent = '√ó';
                del.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const bmData = chip.dataset.bm;
                  const [scope, idx] = bmData.split(':');
                  if (scope === 'personal' && personalBookmarks && personalBookmarks[idx]) {
                    personalBookmarks.splice(idx, 1);
                    renderBookmarksSelect();
                    showMessage('–ó–∞–∫–ª–∞–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞.', 'info');
                  }
                });
                chip.appendChild(del);
              }
              if (!personalEditMode && hasDel) hasDel.remove();
            });
          });
        }
        
        if (sharedEditBtn) {
          sharedEditBtn.addEventListener('click', () => {
            sharedEditMode = !sharedEditMode;
            sharedEditBtn.textContent = '‚úé';
            sharedHost.classList.toggle('ring-1', sharedEditMode);
            sharedHost.classList.toggle('ring-amber-400', sharedEditMode);
            // Add/remove delete buttons on chips
            sharedHost.querySelectorAll('button[data-bm]').forEach((chip) => {
              const hasDel = chip.querySelector('button[data-delete]');
              if (sharedEditMode && !hasDel) {
                const del = document.createElement('button');
                del.type = 'button';
                del.dataset.delete = 'true';
                del.className = 'text-gray-500 hover:text-rose-600 dark:text-gray-400 dark:hover:text-rose-400';
                del.textContent = '√ó';
                del.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const bmData = chip.dataset.bm;
                  const [scope, idx] = bmData.split(':');
                  if (scope === 'shared' && bookmarks && bookmarks[idx]) {
                    bookmarks.splice(idx, 1);
                    renderBookmarksSelect();
                    showMessage('–û–±—â–∞—è –∑–∞–∫–ª–∞–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞.', 'info');
                  }
                });
                chip.appendChild(del);
              }
              if (!sharedEditMode && hasDel) hasDel.remove();
            });
          });
        }

        personalAddBtn.addEventListener('click', async () => {
          const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–ª–∞–¥–∫–∏');
          if (!name) return;
          bmNameInput.value = name;
          const cfg = getCurrentFilterConfig();
          if (!cfg.name) return;
          let newId = null;
          try { newId = await saveBookmarkToServerPersonal(cfg); } catch (_) {}
          await loadBookmarksBoth();
          if (newId !== null) window.__activeBmId = newId;
          renderBookmarksSelect();
          showMessage('–ó–∞–∫–ª–∞–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.', 'info');
        });
        sharedAddBtn.addEventListener('click', async () => {
          const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—â–µ–π –∑–∞–∫–ª–∞–¥–∫–∏');
          if (!name) return;
          bmNameInput.value = name;
          const cfg = getCurrentFilterConfig();
          if (!cfg.name) return;
          let newId = null;
          try { newId = await saveBookmarkToServerShared(cfg); } catch (_) {}
          await loadBookmarksBoth();
          if (newId !== null) window.__activeBmId = newId;
          renderBookmarksSelect();
          showMessage('–û–±—â–∞—è –∑–∞–∫–ª–∞–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.', 'info');
        });
        // expose editMode to renderer
        window.__isBmEditMode = () => personalEditMode || sharedEditMode;
      })();

      function showMapping(headersRaw, preset) {
        mappingControls.innerHTML = '';
         const fields = [
          { key: 'id', label: 'ID' },
          { key: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ' },
          { key: 'company', label: '–ö–æ–º–ø–∞–Ω–∏—è' },
           { key: 'assignee', label: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' },
          { key: 'created', label: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è' },
           { key: 'completed', label: '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è' },
           { key: 'duration', label: '–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è' },
           { key: 'tags', label: '–¢–µ–≥–∏' }
        ];
        for (const f of fields) {
          const wrap = document.createElement('div');
          const lab = document.createElement('label');
          lab.className = 'mb-1 block text-sm font-medium';
          lab.textContent = f.label;
          const sel = document.createElement('select');
          sel.id = `map-${f.key}`;
          sel.className = 'w-full rounded-md border border-gray-300 bg-white p-2 text-sm dark:border-gray-700 dark:bg-gray-900';
          const none = document.createElement('option');
          none.value = '-1';
          none.textContent = '‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî';
          sel.appendChild(none);
          headersRaw.forEach((h, i) => {
            const opt = document.createElement('option');
            opt.value = String(i);
            opt.textContent = `${i + 1}. ${h || '(–ø—É—Å—Ç–æ)'}`;
            sel.appendChild(opt);
          });
          if (typeof preset[f.key] === 'number') {
            sel.value = String(preset[f.key] ?? -1);
          }
          wrap.appendChild(lab);
          wrap.appendChild(sel);
          mappingControls.appendChild(wrap);
        }
        mappingSection.classList.remove('hidden');
      }

      function collectMappingFromUI() {
         return {
          id: parseInt(document.getElementById('map-id').value, 10),
          title: parseInt(document.getElementById('map-title').value, 10),
          company: parseInt(document.getElementById('map-company').value, 10),
           assignee: parseInt(document.getElementById('map-assignee').value, 10),
          created: parseInt(document.getElementById('map-created').value, 10),
           completed: parseInt(document.getElementById('map-completed').value, 10),
           duration: parseInt(document.getElementById('map-duration').value, 10),
           tags: parseInt(document.getElementById('map-tags').value, 10)
        };
      }

      function processHtml(htmlString) {
        hideMessage();
        try {
          const { headersRaw, headersNorm, rows } = extractTable(htmlString);
          lastParsedHeaders = headersRaw;
          lastParsedRows = rows;
          suggestedMapping = suggestMapping(headersNorm);

          const tasks = buildTasks(rows, suggestedMapping);
          if (tasks.length > 0) {
            mappingSection.classList.add('hidden');
            setTasks(tasks);
            if (Object.values(suggestedMapping).some((i) => i < 0)) {
              showMessage('–ß–∞—Å—Ç—å –∫–æ–ª–æ–Ω–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.', 'warn');
            }
          } else {
            showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ.', 'warn');
            showMapping(headersRaw, suggestedMapping);
            resultsCard.classList.add('hidden');
          }
        } catch (err) {
          console.error(err);
          showMessage(err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ HTML.', 'error');
          resultsCard.classList.add('hidden');
          mappingSection.classList.add('hidden');
        }
      }

      function setSelectedFileInfo(file) {
        if (!file) {
          fileMeta.textContent = '';
          parseFileBtn.disabled = true;
          return;
        }
        const sizeKb = Math.round((file.size || 0) / 1024);
        const d = new Date(file.lastModified || Date.now());
        const pad = (n) => String(n).padStart(2, '0');
        const meta = `${file.name || '—Ñ–∞–π–ª'} ‚Ä¢ ${sizeKb} –ö–ë ‚Ä¢ ${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        fileMeta.textContent = meta;
        parseFileBtn.disabled = false;
      }

      function handleFiles(files) {
        if (!files || !files.length) return;
        const file = files[0];
        fileInput.files = files;
        setSelectedFileInfo(file);
      }

      // Dropzone interactions
      if (dropzone) {
        ['dragenter', 'dragover'].forEach((ev) => {
          dropzone.addEventListener(ev, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.add('ring-2', 'ring-gray-400', 'dark:ring-gray-600');
          });
        });
        ['dragleave', 'drop'].forEach((ev) => {
          dropzone.addEventListener(ev, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('ring-2', 'ring-gray-400', 'dark:ring-gray-600');
          });
        });
        dropzone.addEventListener('drop', (e) => {
          const dt = e.dataTransfer;
          if (!dt) return;
          handleFiles(dt.files);
        });
      }

      if (fileInput) {
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
      }

      if (clearFileBtn) {
        clearFileBtn.addEventListener('click', () => {
          fileInput.value = '';
          setSelectedFileInfo(null);
          hideMessage();
           // Reset views
           setTasks([]);
        });
      }

      parseFileBtn.addEventListener('click', async () => {
        hideMessage();
        const file = fileInput.files?.[0];
        if (!file) {
          showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.', 'warn');
          return;
        }
        try {
          const text = await file.text();
          if (!text || !text.trim()) {
            showMessage('–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.', 'error');
            return;
          }
           // persist last source
           saveLastSource({
             type: 'file',
             text,
             fileName: file.name || '',
             size: file.size || 0,
             modified: file.lastModified || Date.now(),
             savedAt: Date.now()
           });
          processHtml(text);
        } catch (e) {
          console.error(e);
          showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ HTML –∏–ª–∏ .xls, —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–∞–∫ HTML.', 'error');
        }
      });

      applyMappingBtn.addEventListener('click', () => {
        if (!lastParsedRows.length) {
          showMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É.', 'warn');
          return;
        }
        const mapping = collectMappingFromUI();
        const tasks = buildTasks(lastParsedRows, mapping);
        if (tasks.length === 0) {
          showMessage('–ü–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–ª–æ–Ω–∫–∞–º –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–±–æ—Ä.', 'error');
          resultsCard.classList.add('hidden');
          return;
        }
        hideMessage();
        setTasks(tasks);
      });

      hideMappingBtn.addEventListener('click', () => {
        mappingSection.classList.add('hidden');
      });

      // Filters: listeners
      const triggerFilter = debounce(applyFilters, 200);
      if (filterQuery) filterQuery.addEventListener('input', triggerFilter);
      if (createdFromInput) createdFromInput.addEventListener('change', triggerFilter);
      if (createdToInput) createdToInput.addEventListener('change', triggerFilter);
      if (completedFromInput) completedFromInput.addEventListener('change', triggerFilter);
      if (completedToInput) completedToInput.addEventListener('change', triggerFilter);

      // Date range pickers (Litepicker)
      function formatDisplayRange(fromISO, toISO) {
        const fmt = (s) => {
          if (!s) return '';
          const d = new Date(s);
          const dd = String(d.getDate()).padStart(2, '0');
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const yyyy = d.getFullYear();
          return `${dd}.${mm}.${yyyy}`;
        };
        if (!fromISO && !toISO) return '';
        return `${fmt(fromISO)} ‚Äî ${fmt(toISO)}`.trim();
      }

      function initRangePicker(inputEl, fromHidden, toHidden) {
        if (!inputEl) return null;
        const picker = new Litepicker({
          element: inputEl,
          singleMode: false,
          autoApply: true,
          format: 'DD.MM.YYYY',
          lang: 'ru-RU',
          tooltipText: { one: '–¥–µ–Ω—å', other: '–¥–Ω–µ–π' },
        });
        picker.on('selected', (date1, date2) => {
          const toISO = (d) => d ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` : '';
          const from = date1 ? new Date(date1.getTime()) : null;
          const to = date2 ? new Date(date2.getTime()) : null;
          if (fromHidden) fromHidden.value = from ? toISO(from) : '';
          if (toHidden) toHidden.value = to ? toISO(to) : '';
          inputEl.value = formatDisplayRange(fromHidden.value, toHidden.value);
          triggerFilter();
        });
        // Clear on backspace/delete
        inputEl.addEventListener('input', () => {
          const val = inputEl.value.trim();
          if (!val) {
            if (fromHidden) fromHidden.value = '';
            if (toHidden) toHidden.value = '';
            triggerFilter();
          }
        });
        return picker;
      }

      const createdPicker = initRangePicker(createdRangeInput, createdFromInput, createdToInput);
      const completedPicker = initRangePicker(completedRangeInput, completedFromInput, completedToInput);
      if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', () => {
          if (filterQuery) filterQuery.value = '';
          if (createdFromInput) createdFromInput.value = '';
          if (createdToInput) createdToInput.value = '';
          if (completedFromInput) completedFromInput.value = '';
          if (completedToInput) completedToInput.value = '';
          if (createdRangeInput) createdRangeInput.value = '';
          if (completedRangeInput) completedRangeInput.value = '';
          filterSettings.tagsKeywords = [];
          filterSettings.tagsMode = 'any';
          filterSettings.employees = [];
          if (tagsKeywordsInput) tagsKeywordsInput.value = '';
          if (tagsModeSelect) tagsModeSelect.value = 'any';
          renderEmployeesChips();
          // clear chips as well
          const incHost = document.getElementById('includeChips');
          const excHost = document.getElementById('excludeChips');
          if (incHost) incHost.replaceChildren();
          if (excHost) excHost.replaceChildren();
          // also clear active bookmark highlight
          window.__activeBmId = null;
          window.__activeBmIdx = -1;
          renderBookmarksSelect();
          applyFilters();
        });
      }

      // Settings: listeners
      function openSettings() {
        if (settingsModal) settingsModal.classList.remove('hidden');
        if (tagsKeywordsInput) tagsKeywordsInput.value = (filterSettings.tagsKeywords || []).join(', ');
        if (tagsModeSelect) tagsModeSelect.value = filterSettings.tagsMode || 'any';
      }
      function closeSettings() {
        if (settingsModal) settingsModal.classList.add('hidden');
      }
      if (openFilterSettingsBtn) openFilterSettingsBtn.addEventListener('click', openSettings);
      if (settingsCloseBtn) settingsCloseBtn.addEventListener('click', closeSettings);
      if (settingsBackdrop) settingsBackdrop.addEventListener('click', closeSettings);
      if (settingsSaveBtn) settingsSaveBtn.addEventListener('click', () => {
        const raw = (tagsKeywordsInput?.value || '').trim();
        const kws = raw
          ? raw.split(/[;,\n\r]+/g).map((s) => s.trim()).filter(Boolean)
          : [];
        filterSettings.tagsKeywords = kws;
        filterSettings.tagsMode = (tagsModeSelect?.value === 'all') ? 'all' : 'any';
        applyFilters();
        closeSettings();
      });

      // Employees helpers
      function renderEmployeesChips() {
        if (!employeesList) return;
        employeesList.innerHTML = '';
        const frag = document.createDocumentFragment();
        (filterSettings.employees || []).forEach((name, idx) => {
          const chip = document.createElement('span');
          chip.className = 'inline-flex items-center gap-1 rounded-full border border-gray-300 bg-white px-2 py-1 text-xs dark:border-gray-700 dark:bg-gray-900';
          const label = document.createElement('span');
          label.textContent = name;
          const btn = document.createElement('button');
          btn.className = 'rounded-full px-1 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200';
          btn.setAttribute('type', 'button');
          btn.textContent = '√ó';
          btn.addEventListener('click', () => {
            filterSettings.employees.splice(idx, 1);
            renderEmployeesChips();
            applyFilters();
          });
          chip.appendChild(label);
          chip.appendChild(btn);
          frag.appendChild(chip);
        });
        employeesList.appendChild(frag);
      }
      function addEmployeeFromInput() {
        const v = (employeeInput?.value || '').trim();
        if (!v) return;
        if (!Array.isArray(filterSettings.employees)) filterSettings.employees = [];
        if (!filterSettings.employees.some((s) => s.toLowerCase() === v.toLowerCase())) {
          filterSettings.employees.push(v);
          renderEmployeesChips();
          applyFilters();
        }
        if (employeeInput) employeeInput.value = '';
      }
      if (addEmployeeBtn) addEmployeeBtn.addEventListener('click', addEmployeeFromInput);
      if (employeeInput) employeeInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addEmployeeFromInput();
        }
      });
      if (applyEmployeesFilterBtn) applyEmployeesFilterBtn.addEventListener('click', () => {
        // Apply employee surnames as tag keywords with ANY mode
        const list = Array.isArray(filterSettings.employees) ? filterSettings.employees : [];
        filterSettings.tagsKeywords = [...list];
        filterSettings.tagsMode = 'any';
        if (tagsKeywordsInput) tagsKeywordsInput.value = list.join(', ');
        if (tagsModeSelect) tagsModeSelect.value = 'any';
        applyFilters();
      });

      // Bookmarks: listeners
      if (saveBookmarkBtn) {
        saveBookmarkBtn.addEventListener('click', async () => {
          const cfg = getCurrentFilterConfig();
          if (!cfg.name) {
            showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–ª–∞–¥–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.', 'warn');
            return;
          }
          // If name already exists, update it, else push new
          let newId = null;
          try { newId = await saveBookmarkToServerPersonal(cfg); } catch (_) {}
          await loadBookmarksBoth();
          if (newId !== null) window.__activeBmId = newId;
          renderBookmarksSelect();
          showMessage('–ó–∞–∫–ª–∞–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.', 'info');
        });
      }

      if (bookmarksSelect) {
        bookmarksSelect.addEventListener('change', () => {
          const val = bookmarksSelect.value;
          if (!val) {
            if (deleteBookmarkBtn) deleteBookmarkBtn.disabled = true;
            return;
          }
          const idx = Number(val);
          const b = bookmarks[idx];
          if (b) {
            bmNameInput.value = b.name || '';
            applyFilterConfig(b && b.config ? b.config : b);
          }
          if (deleteBookmarkBtn) deleteBookmarkBtn.disabled = false;
        });
      }

      if (deleteBookmarkBtn) {
        deleteBookmarkBtn.addEventListener('click', async () => {
          const val = bookmarksSelect.value;
          if (!val) return;
          const idx = Number(val);
          if (idx >= 0 && idx < bookmarks.length) {
            try { await deleteBookmarkOnServerShared(bookmarks[idx]?.id); } catch (_) {}
            await loadBookmarksBoth();
            renderBookmarksSelect();
            bookmarksSelect.value = '';
            if (deleteBookmarkBtn) deleteBookmarkBtn.disabled = true;
            showMessage('–ó–∞–∫–ª–∞–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞.', 'info');
          }
        });
      }

       // Init bookmarks on load
      loadBookmarksBoth();

      // Init auth on load
      loadAuth();
      migrateLegacyAccountsIfAny();
      // Ensure IDB is initialized on first load
      try { openAuthDB().catch(() => {}); } catch (_) {}
      (async () => {
        try { await refreshAuthFromServer(); } catch (_) {}
        if (currentAuth?.username && usernameInput) usernameInput.value = currentAuth.username;
        if (passwordInput) passwordInput.value = '';
        updateAuthStatus();
        applyAuthGate();
        setupPasswordToggles();
      })();

      // Auth listeners
      if (loginBtn) {
        loginBtn.addEventListener('click', async () => {
          const username = (usernameInput?.value || '').trim();
          const password = (passwordInput?.value || '').trim();
          if (!username || !password) {
            showMessage('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.', 'warn');
            return;
          }
          try {
            await serverLogin(username, password);
          } catch (e) {
            showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.', 'error');
            return;
          }
          const payload = { username, savedAt: Date.now() };
          saveAuth(payload);
          currentAuth = payload;
          updateAuthStatus();
          applyAuthGate();
          showMessage('–í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É.', 'info');
        });
      }
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await serverLogout();
          clearAuth();
          if (usernameInput) usernameInput.value = '';
          if (passwordInput) passwordInput.value = '';
          setTasks([]);
          updateAuthStatus();
          applyAuthGate();
          showMessage('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.', 'info');
        });
      }

      // Registration handlers
      const authTabLogin = document.getElementById('authTabLogin');
      const authTabRegister = document.getElementById('authTabRegister');
      const loginPanel = document.getElementById('loginPanel');
      const registerPanel = document.getElementById('registerPanel');
      const regUsernameInput = document.getElementById('regUsernameInput');
      const regPasswordInput = document.getElementById('regPasswordInput');
      const regPassword2Input = document.getElementById('regPassword2Input');
      const registerBtn = document.getElementById('registerBtn');

      function setAuthTab(tab) {
        const isLogin = tab === 'login';
        if (authTabLogin) authTabLogin.setAttribute('aria-pressed', isLogin ? 'true' : 'false');
        if (authTabRegister) authTabRegister.setAttribute('aria-pressed', !isLogin ? 'true' : 'false');
        if (loginPanel) loginPanel.classList.toggle('hidden', !isLogin);
        if (registerPanel) registerPanel.classList.toggle('hidden', isLogin);
        const loginActions = document.getElementById('loginActions');
        if (loginActions) loginActions.classList.toggle('hidden', !isLogin);
      }

      if (authTabLogin && authTabRegister) {
        authTabLogin.addEventListener('click', () => setAuthTab('login'));
        authTabRegister.addEventListener('click', () => setAuthTab('register'));
      }
      // default to login
      setAuthTab('login');
      // ensure correct visibility on load
      updateRepeatVisibility?.();

      if (registerBtn) {
        registerBtn.addEventListener('click', async () => {
          const username = (regUsernameInput?.value || '').trim();
          const p1 = (regPasswordInput?.value || '').trim();
          const p2 = (regPassword2Input?.value || '').trim();
          if (!username || !p1 || !p2) {
            showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –æ–±–∞ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è.', 'warn');
            return;
          }
          if (p1 !== p2) {
            showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.', 'error');
            return;
          }
          try {
            await serverRegister(username, p1);
          } catch (e) {
            showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.', 'error');
            return;
          }
          const payload = { username, savedAt: Date.now() };
          saveAuth(payload);
          currentAuth = payload;
          if (usernameInput) usernameInput.value = username;
          if (passwordInput) passwordInput.value = '';
          updateAuthStatus();
          applyAuthGate();
          showMessage('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥.', 'info');
          setAuthTab('login');
        });
      }

      // Show repeat password only when first password has content
      function updateRepeatVisibility() {
        const row = document.getElementById('regPassword2Row');
        if (!row || !regPasswordInput) return;
        const has = (regPasswordInput.value || '').trim().length > 0;
        row.classList.toggle('hidden', !has);
      }
      if (regPasswordInput) {
        regPasswordInput.addEventListener('input', updateRepeatVisibility);
      }

       // Columns settings: listeners
       if (openColumnsSettingsBtn) openColumnsSettingsBtn.addEventListener('click', openColumnsSettings);
       if (columnsCloseBtn) columnsCloseBtn.addEventListener('click', closeColumnsSettings);
       if (columnsBackdrop) columnsBackdrop.addEventListener('click', closeColumnsSettings);
       if (columnsSaveBtn) columnsSaveBtn.addEventListener('click', applyColumnsSettingsFromModal);

       // Load columns config
       loadVisibleColumns();
       loadColumnWidths();

       // Dashboards: listeners
       document.querySelectorAll('[data-dashboard]').forEach((btn) => {
         btn.addEventListener('click', () => {
           const key = btn.getAttribute('data-dashboard');
           setActiveDashboard(key);
         });
       });

       // Move filters block into top filters card so it appears before dashboards
       (function mountFiltersIntoTopCard() {
         const topCard = document.getElementById('filtersTopCard');
         const mount = document.getElementById('filtersCloneMount');
         const filters = document.getElementById('filters');
         if (topCard && mount && filters) {
           mount.innerHTML = '';
           mount.appendChild(filters);
           topCard.classList.remove('hidden');
         }
       })();

       // Restore last processed source on load
       try {
         const last = loadLastSource();
         if (last && last.type === 'file' && typeof last.text === 'string' && last.text.trim()) {
           processHtml(last.text);
           // Prefill meta info only (show which file is loaded)
           setSelectedFileInfo({ name: last.fileName || '—Ñ–∞–π–ª', size: last.size || 0, lastModified: last.modified || Date.now() });
         }
       } catch (_) {}

      // Details: listeners
      if (detailsCloseBtn) detailsCloseBtn.addEventListener('click', closeTaskDetails);
      if (detailsBackdrop) detailsBackdrop.addEventListener('click', closeTaskDetails);
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeTaskDetails();
      });

      // Toggle long text in details
      if (detailsContent) {
        detailsContent.addEventListener('click', (e) => {
          const btn = e.target.closest('.toggleLongText');
          if (!btn) return;
          const block = btn.closest('.long-text-block');
          if (!block) return;
          const shortEl = block.querySelector('.long-text.short');
          const fullEl = block.querySelector('.long-text.full');
          const isShortHidden = shortEl?.classList.contains('hidden');
          if (isShortHidden) {
            // Collapse
            shortEl.classList.remove('hidden');
            fullEl?.classList.add('hidden');
            btn.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
          } else {
            // Expand
            shortEl?.classList.add('hidden');
            fullEl?.classList.remove('hidden');
            btn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
          }
        });
      }

      // Dashboards: listeners
      document.querySelectorAll('[data-dashboard]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-dashboard');
          setActiveDashboard(key);
        });
      });

      // Debounced real-time filtering
      (function initLiveFiltering() {
        const inc = document.getElementById('filterQuery');
        const exc = document.getElementById('filterExclude');
        const all = null;
        const resetBtn = document.getElementById('resetFilters');
        let t;
        const debounced = () => { clearTimeout(t); t = setTimeout(applyFilters, 250); };
        if (inc) inc.addEventListener('input', debounced);
        if (exc) exc.addEventListener('input', debounced);
        if (all) all.addEventListener('change', debounced);
        if (resetBtn) resetBtn.addEventListener('click', () => {
          if (inc) inc.value = '';
          const e = document.getElementById('filterExclude');
          if (e) e.value = '';
          // clear chips
          document.getElementById('includeChips')?.replaceChildren();
          document.getElementById('excludeChips')?.replaceChildren();
          applyFilters();
        });
      })();

      // Chips for include/exclude
      (function initChips() {
        const includeInput = document.getElementById('filterQuery');
        const excludeInput = document.getElementById('filterExclude');
        const addIncludeBtn = document.getElementById('addIncludeTerm');
        const addExcludeBtn = document.getElementById('addExcludeTerm');
        const includeHost = document.getElementById('includeChips');
        const excludeHost = document.getElementById('excludeChips');
        const includeEditBtn = document.getElementById('includeEditBtn');
        const excludeEditBtn = document.getElementById('excludeEditBtn');
        const norm = (s) => String(s || '').trim();
        let includeEdit = false;
        let excludeEdit = false;
        function renderChip(text, host, editOn) {
          const chip = document.createElement('span');
          const isInclude = host.id === 'includeChips';
          // Different colors for include vs exclude chips
          const baseClasses = isInclude 
            ? 'inline-flex items-center gap-1 rounded-full border border-green-300 bg-green-50 px-2 py-0.5 text-xs text-green-700 dark:border-green-600 dark:bg-green-900/20 dark:text-green-300'
            : 'inline-flex items-center gap-1 rounded-full border border-red-300 bg-red-50 px-2 py-0.5 text-xs text-red-700 dark:border-red-600 dark:bg-red-900/20 dark:text-red-300';
          chip.className = baseClasses;
          chip.dataset.term = text;
          const label = document.createElement('span');
          label.textContent = text;
          chip.appendChild(label);
          if (editOn) {
            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'text-gray-500 hover:text-rose-600 dark:text-gray-400 dark:hover:text-rose-400';
            del.textContent = '√ó';
            del.addEventListener('click', () => { chip.remove(); applyFilters(); saveServerFilters(); });
            chip.appendChild(del);
          }
          host.appendChild(chip);
        }
        function addChip(host, isInclude) {
          const raw = prompt(isInclude ? '–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ä–º–∏–Ω' : '–ò—Å–∫–ª—é—á–∏—Ç—å —Ç–µ—Ä–º–∏–Ω');
          const val = norm(raw);
          if (!val) return;
          renderChip(val, host, isInclude ? includeEdit : excludeEdit);
          applyFilters();
          saveServerFilters();
        }
        if (addIncludeBtn && includeHost) addIncludeBtn.addEventListener('click', () => addChip(includeHost, true));
        if (addExcludeBtn && excludeHost) addExcludeBtn.addEventListener('click', () => addChip(excludeHost, false));
        if (includeEditBtn && includeHost) includeEditBtn.addEventListener('click', () => {
          includeEdit = !includeEdit;
          includeEditBtn.textContent = '‚úé';
          includeHost.classList.toggle('ring-1', includeEdit);
          includeHost.classList.toggle('ring-amber-400', includeEdit);
          includeHost.querySelectorAll('span[data-term]').forEach((chip) => {
            // Ensure chip has correct green color
            chip.className = 'inline-flex items-center gap-1 rounded-full border border-green-300 bg-green-50 px-2 py-0.5 text-xs text-green-700 dark:border-green-600 dark:bg-green-900/20 dark:text-green-300';
            const hasDel = chip.querySelector('button');
            if (includeEdit && !hasDel) {
              const del = document.createElement('button');
              del.type = 'button';
              del.className = 'text-gray-500 hover:text-rose-600 dark:text-gray-400 dark:hover:text-rose-400';
              del.textContent = '√ó';
              del.addEventListener('click', () => { chip.remove(); applyFilters(); saveServerFilters(); });
              chip.appendChild(del);
            }
            if (!includeEdit && hasDel) hasDel.remove();
          });
        });
        if (excludeEditBtn && excludeHost) excludeEditBtn.addEventListener('click', () => {
          excludeEdit = !excludeEdit;
          excludeEditBtn.textContent = '‚úé';
          excludeHost.classList.toggle('ring-1', excludeEdit);
          excludeHost.classList.toggle('ring-amber-400', excludeEdit);
          excludeHost.querySelectorAll('span[data-term]').forEach((chip) => {
            // Ensure chip has correct red color
            chip.className = 'inline-flex items-center gap-1 rounded-full border border-red-300 bg-red-50 px-2 py-0.5 text-xs text-red-700 dark:border-red-600 dark:bg-red-900/20 dark:text-red-300';
            const hasDel = chip.querySelector('button');
            if (excludeEdit && !hasDel) {
              const del = document.createElement('button');
              del.type = 'button';
              del.className = 'text-gray-500 hover:text-rose-600 dark:text-gray-400 dark:hover:text-rose-400';
              del.textContent = '√ó';
              del.addEventListener('click', () => { chip.remove(); applyFilters(); saveServerFilters(); });
              chip.appendChild(del);
            }
            if (!excludeEdit && hasDel) hasDel.remove();
          });
        });
      })();



      // Toggle filters show/hide with expand/collapse button
      (function initFiltersToggle() {
        const toggle = document.getElementById('filtersToggle');
        const body = document.getElementById('filtersBody');
        if (!toggle || !body) return;
        function setState(expanded) {
          body.classList.toggle('hidden', !expanded);
          toggle.textContent = expanded ? '‚ñº' : '‚ñ∂';
          toggle.title = expanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
          toggle.setAttribute('aria-label', expanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å');
        }
        let isExpanded = true;
        setState(isExpanded);
        toggle.addEventListener('click', () => { isExpanded = !isExpanded; setState(isExpanded); });
        toggle.addEventListener('keydown', (e) => {
          if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); isExpanded = !isExpanded; setState(isExpanded); }
        });
      })();

      function loadServerFilters() {}

      async function saveServerFilters() {
        const read = (hostId) => Array.from(document.getElementById(hostId)?.querySelectorAll('span[data-term]')||[]).map(n=>n.dataset.term);
        const payload = { include: read('includeChips'), exclude: read('excludeChips') };
        try { await fetch('/api/filters', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ filters: payload }) }); } catch(_){}
      }

      // Load shared filters/bookmarks from server on init
      loadServerFilters();

      // Saving filters globally is disabled; filters live inside bookmarks only
      function saveServerFilters() {}

      // Load shared filters/bookmarks from server on init
      (function initEmptyFilters(){
        document.getElementById('includeChips')?.replaceChildren();
        document.getElementById('excludeChips')?.replaceChildren();
        applyFilters();
      })();
      
      // Update existing chips with new colors
      (function updateExistingChipsColors() {
        const includeHost = document.getElementById('includeChips');
        const excludeHost = document.getElementById('excludeChips');
        
        if (includeHost) {
          includeHost.querySelectorAll('span[data-term]').forEach((chip) => {
            chip.className = 'inline-flex items-center gap-1 rounded-full border border-green-300 bg-green-50 px-2 py-0.5 text-xs text-green-700 dark:border-green-600 dark:bg-green-900/20 dark:text-green-300';
          });
        }
        
        if (excludeHost) {
          excludeHost.querySelectorAll('span[data-term]').forEach((chip) => {
            chip.className = 'inline-flex items-center gap-1 rounded-full border border-red-300 bg-red-50 px-2 py-0.5 text-xs text-red-700 dark:border-red-600 dark:bg-red-900/20 dark:text-red-300';
          });
        }
      })();
    </script>
  </body>
  </html>



